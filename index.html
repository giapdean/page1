<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMS - Learning Management System</title>
  <!-- Plus Jakarta Sans - Modern Tech Font -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Quill.js Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <style>
    /* ================= DEEP DARK + GLASSMORPHISM DESIGN SYSTEM ================= */

    :root {
      /* Deep Dark Color Palette */
      --bg-950: #050507;
      --bg-900: #09090B;
      --bg-800: #121216;
      --bg-700: #18181B;
      --border: #1F1F23;
      --border-light: #27272A;

      /* Text Colors */
      --text-primary: #FAFAFA;
      --text-secondary: #A1A1AA;
      --text-muted: #71717A;

      /* Brand & Accent */
      --brand-red: #DC2626;
      --brand-red-light: #EF4444;
      --glow-red: rgba(220, 38, 38, 0.3);
      --glow-red-intense: rgba(220, 38, 38, 0.5);

      /* Semantic Colors */
      --success: #22C55E;
      --success-bg: rgba(34, 197, 94, 0.1);
      --warning: #EAB308;
      --warning-bg: rgba(234, 179, 8, 0.1);
      --info: #3B82F6;
      --info-bg: rgba(59, 130, 246, 0.1);
      --error: #EF4444;
      --error-bg: rgba(239, 68, 68, 0.1);

      /* Gradients */
      --gradient-red: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
      --gradient-sidebar-active: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, transparent 100%);

      /* Glass Effect */
      --glass-bg: rgba(18, 18, 22, 0.8);
      --glass-border: rgba(255, 255, 255, 0.05);

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px var(--glow-red);

      /* Transitions */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-900);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-700);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    /* Quill Editor Dark Theme Override */
    .ql-toolbar.ql-snow {
      background: var(--bg-800);
      border-color: var(--border);
      border-radius: 8px 8px 0 0;
    }

    .ql-container.ql-snow {
      border-color: var(--border);
      border-radius: 0 0 8px 8px;
    }

    .ql-editor {
      background: var(--bg-900);
      color: var(--text-primary);
      min-height: 150px;
    }

    .ql-editor.ql-blank::before {
      color: var(--text-muted);
      font-style: normal;
    }

    .ql-snow .ql-stroke {
      stroke: var(--text-muted);
    }

    .ql-snow .ql-fill,
    .ql-snow .ql-stroke.ql-fill {
      fill: var(--text-muted);
    }

    .ql-snow.ql-toolbar button:hover .ql-stroke,
    .ql-snow.ql-toolbar button.ql-active .ql-stroke {
      stroke: var(--brand-red);
    }

    .ql-snow.ql-toolbar button:hover .ql-fill,
    .ql-snow.ql-toolbar button.ql-active .ql-fill {
      fill: var(--brand-red);
    }

    .ql-snow .ql-picker-label {
      color: var(--text-muted);
    }

    .ql-snow .ql-picker-options {
      background: var(--bg-800);
      border-color: var(--border);
    }

    .ql-snow .ql-picker-item {
      color: var(--text-primary);
    }

    .ql-snow .ql-picker-item:hover {
      color: var(--brand-red);
    }

    body {
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-950);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      position: relative;
      z-index: 1;
    }

    /* ============ TOPBAR (Student Layout) ============ */
    .topbar {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--glass-bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .topbar-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* ============ TYPOGRAPHY ============ */
    .topbar h2,
    .auth-title,
    .modal-title,
    h3 {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
    }

    .topbar h2 {
      font-size: 24px;
    }

    /* ============ FOCUS MODE HEADER ============ */
    .focus-header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: var(--bg-950);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .focus-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-800);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-circle:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
    }

    /* ============ FOCUS LAYOUT ============ */
    .lesson-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      min-height: calc(100vh - 64px);
    }

    @media (max-width: 1024px) {
      .lesson-layout {
        grid-template-columns: 1fr;
      }
    }

    .lesson-main {
      background: var(--bg-950);
      padding: 40px 24px;
      /* More vertical space, standard horizontal */
      display: flex;
      flex-direction: column;
      gap: 32px;
      max-width: 1100px;
      /* Slightly narrower for better focus */
      margin: 0 auto;
      width: 100%;
    }

    .lesson-sidebar {
      background: var(--bg-900);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
      position: sticky;
      top: 64px;
    }

    /* ============ VIDEO PLAYER (STABLE) ============ */
    .video-container {
      position: relative;
      width: 100%;
      background: black;
      aspect-ratio: 16/9;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border);
    }

    /* Block Pop-out button on Google Drive Video */
    .video-controls-blocker {
      position: absolute;
      top: 0;
      right: 0;
      width: 140px;
      /* Increased to ensure coverage */
      height: 100px;
      z-index: 50;
      /* Super high to stay above iframe */
      background: transparent;
      cursor: default;
    }

    /* ============ HERO & OVERVIEW ============ */
    .hero-section {
      padding: 40px 4% 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .hero-welcome {
      margin-bottom: 32px;
    }

    .hero-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff 0%, #aaa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .hero-subtitle {
      color: var(--text-muted);
      font-size: 16px;
    }

    /* QUICK STATS */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }

    .stat-box {
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: var(--transition);
    }

    .stat-box:hover {
      border-color: var(--brand-red);
      transform: translateY(-2px);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(220, 38, 38, 0.1);
      color: var(--brand-red);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-info h4 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      line-height: 1;
    }

    .stat-info p {
      font-size: 13px;
      color: var(--text-muted);
      margin: 4px 0 0;
    }

    /* FEATURED COURSE (LAST VIEWED) */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 0 4%;
      max-width: 1400px;
      margin: 0 auto 24px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .featured-card {
      background: var(--bg-800);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      margin: 0 4% 40px;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      transition: var(--transition);
    }

    .featured-card:hover {
      border-color: var(--brand-red);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .featured-thumb {
      width: 45%;
      min-height: 280px;
      object-fit: cover;
      position: relative;
    }

    .featured-content {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .featured-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(220, 38, 38, 0.2);
      color: var(--brand-red);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
      width: fit-content;
    }

    @media (max-width: 768px) {
      .featured-card {
        flex-direction: column;
      }

      .featured-thumb {
        width: 100%;
        height: 200px;
      }

      .featured-content {
        padding: 24px;
      }

      .hero-section {
        padding: 24px 4% 0;
      }
    }

    .play-btn-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s, background 0.3s;
    }

    .video-overlay:hover .play-btn-large {
      transform: scale(1.1);
      background: rgba(220, 38, 38, 0.8);
      border-color: transparent;
    }

    /* ============ PLAYLIST SIDEBAR ============ */
    .playlist-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .playlist-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .playlist-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.7;
    }

    .playlist-item:hover {
      background: var(--bg-800);
      opacity: 1;
    }

    .playlist-item.active {
      background: var(--bg-800);
      border: 1px solid rgba(220, 38, 38, 0.5);
      opacity: 1;
    }

    .playlist-item.locked {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .playlist-item.checked {
      opacity: 0.6;
    }

    .playlist-item.checked:hover {
      opacity: 1;
    }

    .playlist-status {
      width: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .playlist-info {
      flex: 1;
    }

    .playlist-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .playlist-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .playlist-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-900);
      position: sticky;
      bottom: 0;
    }

    /* ============ BENTO TABS (BELOW VIDEO) ============ */
    .bento-tabs {
      padding: 24px;
    }

    .tab-header {
      display: flex;
      gap: 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .tab-btn {
      padding: 12px 0;
      background: none;
      border: none;
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      position: relative;
      transition: var(--transition);
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--brand-red);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--brand-red);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    /* Material Card */
    .material-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: var(--transition);
      text-decoration: none;
    }

    .material-card:hover {
      border-color: var(--brand-red);
      transform: translateY(-2px);
    }

    .file-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .live-badge {
      padding: 6px 12px;
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid var(--brand-red);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 800;
      color: var(--brand-red);
      display: flex;
      align-items: center;
      gap: 6px;
      animation: pulse-live 2s infinite;
      letter-spacing: 1px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--brand-red);
      border-radius: 50%;
      animation: blink-dot 1s infinite;
    }

    @keyframes pulse-live {

      0%,
      100% {
        box-shadow: 0 0 5px rgba(220, 38, 38, 0.4);
      }

      50% {
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.7);
      }
    }

    @keyframes blink-dot {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    .user-info {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
    }

    /* ============ BUTTONS ============ */
    .btn {
      padding: 10px 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-800);
      color: var(--text-primary);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn:hover {
      border-color: var(--border-light);
      background: var(--bg-700);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-800);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-sm:hover {
      background: var(--bg-700);
      color: var(--text-primary);
    }

    .btn-red {
      background: var(--gradient-red);
      border: none;
      color: white;
      box-shadow: 0 0 15px var(--glow-red);
    }

    .btn-red:hover {
      box-shadow: 0 0 25px var(--glow-red-intense);
      transform: translateY(-1px);
    }

    .btn-logout {
      padding: 8px 16px;
      font-size: 12px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      background: transparent;
    }

    .btn-logout:hover {
      background: var(--error-bg);
      border-color: var(--error);
    }

    .btn-teacher,
    .form-btn {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: var(--gradient-red);
      color: white;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 0 15px var(--glow-red);
    }

    .btn-teacher:hover,
    .form-btn:hover {
      box-shadow: 0 0 25px var(--glow-red-intense);
      transform: translateY(-1px);
    }

    /* ============ AUTH CONTAINER (Login/Register) ============ */
    .auth-container {
      max-width: 420px;
      margin: 80px auto;
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow-lg);
    }

    .auth-title {
      font-size: 28px;
      text-align: center;
      margin-bottom: 32px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-900);
      color: var(--text-primary);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--brand-red);
      box-shadow: 0 0 0 3px var(--glow-red);
      background: var(--bg-800);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 100px;
    }

    .form-btn {
      width: 100%;
      padding: 16px;
      margin-top: 24px;
      font-size: 16px;
      border-radius: 12px;
    }

    .form-link {
      text-align: center;
      margin-top: 24px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .form-link a {
      color: var(--brand-red);
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .form-link a:hover {
      color: #F87171;
      text-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
    }

    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      text-align: center;
      font-weight: 600;
    }

    .alert-success {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid var(--brand-red);
      color: var(--brand-red);
    }

    .alert-error {
      background: rgba(255, 50, 50, 0.1);
      border: 1px solid #ff0000;
      color: #ff4444;
    }

    /* ============ MODALS ============ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      backdrop-filter: blur(8px);
    }

    .modal-overlay.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 800px;
      width: 100%;
      margin: 40px auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .modal-title {
      font-size: 24px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: 2px solid var(--border-light);
      border-radius: 50%;
      background: transparent;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--brand-red);
      border-color: var(--brand-red);
      color: white;
      transform: rotate(90deg);
      box-shadow: var(--glow-red);
    }

    .lesson-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      position: relative;
    }

    .lesson-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .lesson-title {
      color: var(--text-light);
      font-weight: 800;
      font-size: 18px;
      text-transform: uppercase;
    }

    .btn-remove {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid #ff4444;
      background: rgba(255, 0, 0, 0.1);
      color: #ff4444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .btn-remove:hover {
      background: #ff4444;
      color: white;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    }

    .btn-add-lesson {
      border: 2px dashed var(--border-light);
      background: transparent;
      color: var(--text-muted);
      padding: 16px;
      font-weight: 700;
    }

    .btn-add-lesson:hover {
      background: rgba(220, 38, 38, 0.05);
      border-color: var(--brand-red);
      color: var(--brand-red);
    }

    .file-input-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-pick-file {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--border-light);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-light);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }

    .btn-pick-file:hover {
      border-color: var(--brand-red);
      color: var(--brand-red);
      background: rgba(220, 38, 38, 0.1);
    }

    .info-box {
      background: rgba(220, 38, 38, 0.05);
      border-left: 4px solid var(--brand-red);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .info-box-title {
      color: var(--brand-red);
      font-weight: 800;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .info-box-content {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
    }

    code {
      background: rgba(0, 0, 0, 0.5);
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      display: block;
      white-space: pre;
      overflow-x: auto;
      border: 1px solid var(--border-light);
    }

    /* ============ COURSE GRID ============ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }

    .card {
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: var(--border-light);
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }

    .thumb {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: var(--bg-700);
      border-radius: 12px 12px 0 0;
      position: relative;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }

    .card:hover .thumb {
      opacity: 0.9;
    }

    .card.locked {
      pointer-events: none;
      opacity: 0.5;
    }

    .card.locked .course-actions {
      display: none !important;
    }

    .locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      font-weight: 800;
      font-size: 20px;
      text-transform: uppercase;
      z-index: 5;
      backdrop-filter: blur(2px);
    }

    .locked-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: #555;
    }

    .card h3 {
      font-size: 16px;
      font-weight: 700;
      margin: 16px 16px 8px;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .card:hover h3 {
      color: var(--text-primary);
    }

    .muted {
      color: var(--text-muted);
      font-size: 13px;
      margin: 0 16px 16px;
      font-weight: 400;
      line-height: 1.5;
    }

    .course-actions {
      display: none;
      position: absolute;
      top: 16px;
      right: 16px;
      gap: 12px;
      z-index: 10;
    }

    .card:hover .course-actions {
      display: flex;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      border: 1px solid var(--border-light);
      background: rgba(0, 0, 0, 0.5);
      color: var(--text-light);
    }

    .btn-refresh:hover {
      background: #10b981;
      border-color: #10b981;
      color: white;
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
      transform: scale(1.1);
    }

    .btn-edit:hover {
      background: var(--brand-red);
      border-color: var(--brand-red);
      color: white;
      box-shadow: var(--glow-red);
      transform: scale(1.1);
    }

    .btn-delete:hover {
      background: #ff0000;
      border-color: #ff0000;
      color: white;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
      transform: scale(1.1);
    }

    h3 {
      color: var(--text-light);
      font-size: 24px;
      font-weight: 800;
      margin: 40px 0 24px;
      background: none;
      -webkit-text-fill-color: initial;
    }

    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .lesson {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .lesson:hover {
      border-color: var(--brand-red);
      box-shadow: 0 5px 20px rgba(220, 38, 38, 0.2);
      transform: translateY(-4px);
      background: rgba(220, 38, 38, 0.05);
    }

    .lesson .muted {
      color: var(--brand-red);
      font-weight: 700;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
    }

    .lesson>div:last-child {
      color: var(--text-light);
      font-size: 16px;
      font-weight: 700;
    }

    #playerWrap {
      position: relative;
      width: 100%;
      user-select: none;
      margin-top: 32px;
    }

    #playerWrap iframe {
      width: 100%;
      height: 600px;
      border: 1px solid var(--border-light);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    .video-controls-blocker {
      background: linear-gradient(to left, #050505 0%, rgba(5, 5, 5, 0) 100%);
      border-top-right-radius: 20px;
    }

    .video-security-notice {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid var(--brand-red);
      color: var(--brand-red);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 10px 20px;
      border-radius: 50px;
      bottom: 30px;
    }

    a {
      color: var(--text-light);
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      display: inline-block;
      padding: 12px 24px;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 14px;
    }

    a:hover {
      background: var(--brand-red);
      border-color: var(--brand-red);
      color: white;
      box-shadow: var(--glow-red);
    }

    #courseDesc {
      background: rgba(255, 255, 255, 0.03);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 32px;
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.6;
      border: 1px solid var(--border-light);
    }

    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--brand-red);
      font-size: 24px;
      z-index: 9999;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: var(--glow-red);
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(-50%) translateX(0);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateX(-10px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateX(10px);
      }
    }

    /* ================= TOAST NOTIFICATIONS ================= */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      background: #1e1e1e;
      /* Hardcoded dark bg to match potential dark mode */
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      min-width: 320px;
      max-width: 450px;
      color: #fff;
      font-size: 14px;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }

    .toast.success {
      border-left: 4px solid #22c55e;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast.info {
      border-left: 4px solid #3b82f6;
    }

    /* Blue */
    .toast.warning {
      border-left: 4px solid #f59e0b;
    }

    /* Yellow */

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOutUp {
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }


    /* ================= ADMIN DASHBOARD - DEEP DARK + GLASSMORPHISM ================= */

    .admin-layout {
      display: flex;
      height: 100vh;
      background: var(--bg-950);
      color: var(--text-primary);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 2000;
    }

    /* Sidebar */
    .admin-sidebar {
      width: 260px;
      background: var(--bg-900);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      flex-shrink: 0;
    }

    .admin-logo {
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 24px;
      font-weight: 700;
      font-size: 18px;
      color: var(--brand-red);
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .admin-menu {
      padding: 16px 0;
      flex: 1;
      overflow-y: auto;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
      font-weight: 500;
      position: relative;
    }

    .menu-item:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.02);
    }

    .menu-item.active {
      color: var(--brand-red);
      background: var(--gradient-sidebar-active);
    }

    .menu-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--brand-red);
      border-radius: 0 2px 2px 0;
    }

    .menu-icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    .admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-950);
    }

    .admin-header {
      height: 64px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      background: var(--bg-900);
    }

    .admin-content {
      padding: 32px;
      overflow-y: auto;
      flex: 1;
    }

    .admin-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--text-primary);
    }

    /* ============ GLASS CARDS (Bento Grid) ============ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--bg-800);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }

    .stat-card:hover {
      border-color: var(--brand-red);
      transform: translateY(-4px);
      box-shadow: 0 10px 30px -10px rgba(220, 38, 38, 0.2);
    }

    /* Background Watermark Icon */
    .stat-card .stat-icon-bg {
      position: absolute;
      right: -10px;
      bottom: -10px;
      width: 100px;
      height: 100px;
      opacity: 0.05;
      transition: var(--transition);
      pointer-events: none;
    }

    .stat-card:hover .stat-icon-bg {
      opacity: 0.1;
      transform: scale(1.1);
    }

    /* Top Icon (Small badge) */
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 8px;
      align-self: flex-start;
    }

    .stat-icon.purple {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
    }

    .stat-icon.yellow {
      background: rgba(234, 179, 8, 0.1);
      color: #eab308;
    }

    .stat-icon.green {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }

    .stat-icon.blue {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .stat-icon.red {
      background: rgba(220, 38, 38, 0.1);
      color: var(--brand-red);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 40px;
      font-weight: 900;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-trend {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* Progress Bar at bottom */
    .stat-progress {
      width: 100%;
      height: 4px;
      background: var(--bg-700);
      border-radius: 10px;
      overflow: hidden;
      margin-top: auto;
    }

    .stat-progress-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.6s ease;
    }

    .stat-progress-fill.purple {
      background: #a855f7;
    }

    .stat-progress-fill.yellow {
      background: #eab308;
    }

    .stat-progress-fill.green {
      background: #22c55e;
    }

    .stat-progress-fill.blue {
      background: #3b82f6;
    }

    .stat-progress-fill.red {
      background: var(--brand-red);
    }

    /* ============ DATA TABLE ============ */
    .table-card {
      background: var(--bg-800);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    .data-table th {
      padding: 14px 24px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-900);
    }

    .data-table td {
      padding: 14px 24px;
      color: var(--text-secondary);
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* ============ STATUS BADGES ============ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-active {
      background: var(--success-bg);
      color: var(--success);
    }

    .status-inactive {
      background: var(--error-bg);
      color: var(--error);
    }

    .status-pending {
      background: var(--warning-bg);
      color: var(--warning);
    }

    /* ============ CHART STYLES ============ */
    .chart-period {
      background: var(--bg-700);
      border: none;
      color: var(--text-muted);
    }

    .chart-period:hover {
      background: var(--bg-800);
      color: var(--text-primary);
    }

    .chart-period.active {
      background: var(--gradient-red);
      color: white;
      box-shadow: 0 0 10px var(--glow-red);
    }

    /* View Profile Modal */
    .profile-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: 0.2s;
    }

    .profile-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .profile-modal {
      width: 900px;
      max-width: 95%;
      background: var(--admin-bg);
      border-radius: 12px;
      border: 1px solid #333;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .profile-header {
      background: var(--admin-card);
      padding: 32px;
      display: flex;
      align-items: center;
      gap: 24px;
      border-bottom: 1px solid #333;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      border: 2px solid var(--admin-accent);
      color: #fff;
    }

    .profile-info h2 {
      margin: 0 0 4px 0;
      color: #fff;
      font-size: 24px;
    }

    .profile-info p {
      margin: 0;
      color: #888;
      font-size: 14px;
    }

    .profile-body {
      padding: 32px;
      background: #000;
      overflow-y: auto;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 32px;
    }

    .info-card {
      background: var(--admin-card);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .info-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      display: block;
    }

    .info-value {
      font-size: 16px;
      color: #fff;
      font-weight: 500;
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-sidebar {
        position: fixed;
        left: -260px;
        height: 100%;
        transition: 0.3s;
        z-index: 2100;
      }

      .admin-sidebar.open {
        left: 0;
      }

      .profile-grid {
        grid-template-columns: 1fr;
      }
    }

    .search-wrapper {
      position: relative;
      max-width: 320px;
      width: 100%;
      margin: 0 16px;
      margin-left: auto;
    }

    .search-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.08) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      color: #fff !important;
      padding: 10px 16px 10px 36px !important;
      border-radius: 99px !important;
      transition: all 0.2s;
      font-size: 14px;
    }

    .search-input:focus {
      background: rgba(255, 255, 255, 0.12) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
      outline: none !important;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
      pointer-events: none;
    }

    .search-dropdown {
      position: absolute;
      top: 110%;
      left: 0;
      right: 0;
      background: #1e1e1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      max-height: 480px;
      overflow-y: auto;
      display: none;
      scrollbar-width: thin;
    }

    .search-dropdown.active {
      display: block;
      animation: slideIn 0.1s;
    }

    .search-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.1s;
    }

    .search-item:last-child {
      border-bottom: none;
    }

    .search-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .search-item img {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
      background: #333;
      flex-shrink: 0;
    }

    .search-meta {
      flex: 1;
      min-width: 0;
    }

    .search-title {
      font-weight: 500;
      color: #fff;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-subtitle {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-tag {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.6);
      flex-shrink: 0;
    }

    /* Mobile Responsive Search */
    @media (max-width: 600px) {
      .search-wrapper {
        order: 3;
        max-width: 100%;
        margin: 12px 0 0 0;
        width: 100%;
        flex-basis: 100%;
      }

      .topbar {
        flex-wrap: wrap;
      }
    }

    /* ================= PROGRESS & SIDEBAR ================= */
    .lesson-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 32px;
      margin-top: 24px;
    }

    .lesson-main {
      width: 100%;
    }

    .lesson-sidebar {
      background: var(--brand-card);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 16px;
      height: fit-content;
      max-height: 80vh;
      overflow-y: auto;
    }

    .lesson-sidebar h3 {
      font-size: 16px;
      color: var(--text-light);
      margin-top: 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 12px;
    }

    .sidebar-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.2s ease;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .sidebar-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .sidebar-item.active {
      background: rgba(220, 38, 38, 0.1);
      border-left: 3px solid var(--brand-red);
    }

    .sidebar-item-status {
      font-size: 14px;
      width: 20px;
      text-align: center;
    }

    .sidebar-item-title {
      font-size: 14px;
      color: var(--text-muted);
    }

    .sidebar-item.active .sidebar-item-title {
      color: var(--brand-red);
      font-weight: 700;
    }

    .btn-complete {
      width: 100%;
      background: var(--brand-red);
      color: white;
      padding: 16px;
      font-size: 16px;
      font-weight: 800;
      border: none;
      border-radius: 12px;
      margin-top: 24px;
      cursor: pointer;
      box-shadow: var(--glow-red);
      text-transform: uppercase;
      transition: all 0.3s ease;
    }

    .btn-complete:hover {
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.6);
    }

    @media (max-width: 900px) {
      .lesson-layout {
        grid-template-columns: 1fr;
      }
    }

    /* NEW COURSE CARD ACTIONS */
    .course-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex !important;
      gap: 6px;
      z-index: 20;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.2s ease-out;
    }

    .card:hover .course-actions {
      opacity: 1;
      transform: translateY(0);
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: white;
      color: black;
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    .btn-icon i,
    .btn-icon svg {
      width: 14px;
      height: 14px;
      stroke-width: 2px;
    }

    /* Specific Colors on Hover */
    .btn-report:hover {
      color: #3b82f6;
      border-color: #3b82f6;
    }

    .btn-add-student:hover {
      color: #10b981;
      border-color: #10b981;
    }

    .btn-refresh:hover {
      color: #f59e0b;
      border-color: #f59e0b;
    }

    .btn-edit:hover {
      color: #8b5cf6;
      border-color: #8b5cf6;
    }

    .btn-delete:hover {
      color: #ef4444;
      border-color: #ef4444;
    }

    /* LESSON DETAIL BTN */
    .btn-lesson-detail-mini {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #a1a1aa;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-lesson-detail-mini:hover {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    /* MODAL LEVEL 2 (Detail) */
    .modal-overlay-2 {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      /* Highest priority */
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }

    /* Report Tab Control */
    .report-tab {
      display: none;
    }

    .report-tab.active {
      display: block !important;
      animation: fadeIn 0.3s;
    }

    /* Report Table - MUST be in head for dynamic content */
    .report-table {
      width: 100%;
      border-collapse: collapse;
    }

    .report-table th {
      font-size: 10px;
      text-transform: uppercase;
      font-weight: 700;
      color: #52525B;
      letter-spacing: 0.05em;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #1F1F23;
    }

    .report-table td {
      padding: 16px;
      font-size: 13px;
      color: #A1A1AA;
      border-bottom: 1px solid rgba(31, 31, 35, 0.5);
    }

    .report-table tr:hover {
      background: rgba(24, 24, 27, 0.5);
    }

    .report-table .email {
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
    }

    .report-table .name {
      color: white;
      font-weight: 600;
    }

    /* Report Badge */
    .report-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .report-badge.success {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
    }

    .report-badge.warning {
      background: rgba(249, 115, 22, 0.15);
      color: #fb923c;
    }

    .report-badge.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    .report-badge.neutral {
      background: rgba(113, 113, 122, 0.15);
      color: #a1a1aa;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <div id="modalAddCourse" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">THM KHA HC TH CNG</h2>
        <button class="modal-close" onclick="closeModalAddCourse()"></button>
      </div>
      <div id="modalMsg"></div>
      <form id="formAddCourse" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label">Tn kha hc *</label>
          <input type="text" class="form-input" id="courseName" required>
        </div>
        <div class="form-group">
          <label class="form-label">M t kha hc</label>
          <textarea class="form-input" id="courseDesc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Thumbnail</label>
          <input type="text" class="form-input" id="courseThumbnail" placeholder="Link Drive hoc URL">
          <div class="file-input-group">
            <button type="button" class="btn-pick-file" onclick="pickThumbnail()"> Chn t Drive</button>
          </div>
        </div>
        <hr style="border: 1px solid var(--border-light); margin: 32px 0;">
        <h3>Danh sch bi hc</h3>
        <div id="lessonsContainer"></div>
        <button type="button" class="btn btn-add-lesson" onclick="addLessonField()"
          style="width: 100%; margin-top: 24px;">+ Thm bi hc</button>
        <button type="submit" class="form-btn" style="margin-top: 32px;">To kha hc</button>
      </form>
    </div>
  </div>

  <div id="modalEditCourse" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title"> CHNH SA KHA HC</h2>
        <button class="modal-close" onclick="closeModalEditCourse()"></button>
      </div>
      <div id="modalEditMsg"></div>
      <form id="formEditCourse" onsubmit="return false;">
        <input type="hidden" id="editOldCourseName">
        <div class="form-group">
          <label class="form-label">Tn kha hc *</label>
          <input type="text" class="form-input" id="editCourseName" required>
        </div>
        <div class="form-group">
          <label class="form-label">M t kha hc</label>
          <textarea class="form-input" id="editCourseDesc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Thumbnail</label>
          <input type="text" class="form-input" id="editCourseThumbnail" placeholder="Link Drive hoc URL">
          <div class="file-input-group">
            <button type="button" class="btn-pick-file" onclick="pickThumbnail()"> Chn t Drive</button>
          </div>
        </div>
        <hr style="border: 1px solid var(--border-light); margin: 32px 0;">
        <h3>Danh sch bi hc</h3>
        <div id="editLessonsContainer"></div>
        <button type="button" class="btn btn-add-lesson" onclick="addEditLessonField()"
          style="width: 100%; margin-top: 24px;">+ Thm bi hc</button>
        <button type="submit" class="form-btn" style="margin-top: 32px;"> Lu thay i</button>
      </form>
    </div>
  </div>

  <div id="modalQuickAdd" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title"> THM NHANH KHA HC</h2>
        <button class="modal-close" onclick="closeModalQuickAdd()"></button>
      </div>
      <div class="info-box">
        <div class="info-box-title"> Cu trc folder yu cu:</div>
        <div class="info-box-content">
          <code>Kha Hc D/
 thumbnail.jpg
 Bi 1: Gii thiu/
    video.mp4
    material.pdf
 Bi 2: Ni dung/
     lesson.mp4
     slides.pdf</code>
        </div>
      </div>
      <div id="quickAddMsg"></div>
      <form id="formQuickAdd" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label">Link Google Drive Folder *</label>
          <input type="text" class="form-input" id="quickFolderUrl"
            placeholder="https://drive.google.com/drive/folders/..." required>
          <div style="color: var(--text-muted); font-size: 12px; margin-top: 8px; font-weight: 500;">
             m bo folder  c share "Anyone with the link can view"
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">M t kha hc (ty chn)</label>
          <textarea class="form-input" id="quickCourseDesc" rows="3" placeholder="M t ngn v kha hc..."></textarea>
        </div>
        <button type="submit" class="form-btn"> Thm nhanh</button>
      </form>
    </div>
  </div>

  <div id="modalAddStudent" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title"> THM HC VIN</h2>
        <button class="modal-close" onclick="closeModalAddStudent()"></button>
      </div>
      <div id="addStudentMsg"></div>
      <form id="formAddStudent" onsubmit="return false;">
        <input type="hidden" id="addStudentCourseName">
        <div class="info-box">
          <div class="info-box-title">Kha hc: <span id="lblCourseName" style="color:var(--text-light)"></span></div>
        </div>
        <div class="form-group">
          <label class="form-label">Email hc vin (Mi dng 1 email hoc cch nhau du phy)</label>
          <textarea class="form-input" id="studentEmails" rows="5" required
            placeholder="nguyenva@gmail.com, tranvb@gmail.com..."></textarea>
        </div>
        <button type="submit" class="form-btn">THM HC VIN</button>
      </form>
    </div>
  </div>

  <!-- MODAL FORGOT PASSWORD (OTP) -->
  <div id="modalForgotPassword" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title"> QUN MT KHU</h2>
        <button class="modal-close" onclick="closeModalForgotPassword()"></button>
      </div>
      <div id="forgotMsg"></div>

      <!-- STEP 1: Gi OTP -->
      <div id="forgotStep1">
        <div class="form-group">
          <label class="form-label">Email ca bn</label>
          <input type="email" class="form-input" id="resetEmail" required placeholder="Nhp email  ng k">
        </div>
        <button class="form-btn" onclick="handleSendOTP()">Gi m OTP</button>
      </div>

      <!-- STEP 2: Xc nhn OTP & i Pass -->
      <div id="forgotStep2" style="display:none;">
        <div class="form-group">
          <label class="form-label">M OTP ( gi v email)</label>
          <input type="text" class="form-input" id="resetOTP" required placeholder="6 s" maxlength="6">
        </div>
        <div class="form-group">
          <label class="form-label">Mt khu mi</label>
          <input type="password" class="form-input" id="resetNewPass" required placeholder="Nhp mt khu mi"
            minlength="6">
        </div>
        <button class="form-btn" onclick="handleVerifyReset()">Xc nhn i mt khu</button>
        <div style="text-align:center;margin-top:12px;">
          <a onclick="backToStep1()" style="color:#aaa;font-size:13px;cursor:pointer;"> Gi li OTP</a>
        </div>
      </div>

    </div>
  </div>
  <script>
    // ========== CU HNH API - THAY I URL NY ==========
    // ========== CU HNH API - THAY I URL NY ==========
    const API_URL = 'https://script.google.com/macros/s/AKfycbxjZCBBzlFbrBs8dBLKQ5yDU9Ff6FxBQibTHg6i1eMFbWOO-7frvAJsYsRc7R1vbOe8_g/exec';

    // Helper: Escape HTML (Fix for blank report)
    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Hm gi API
    //  I SANG FormData
    // ==========================================
    // ADMIN DASHBOARD LOGIC
    // ==========================================

    // 1. MAIN RENDER (Refactored to merge ACADEMY ADMIN visuals)
    function renderAdminDashboard(initialTab = 'overview') {
      state.view = 'admin_dashboard';
      setUrl({ view: 'dashboard', tab: initialTab });

      app.innerHTML = `
        <div class="admin-layout">
           <!-- SIDEBAR (ACADEMY ADMIN STYLE) -->
           <div class="admin-sidebar" id="adminSidebar" style="background:var(--bg-900);border-right:1px solid var(--border)">
              <div class="admin-top" style="padding:24px;border-bottom:1px solid var(--border-light)">
                 <div class="logo" style="font-size:20px;color:var(--brand-red)">ACADEMY <span style="color:var(--text-primary);font-weight:400">ADMIN</span></div>
              </div>
              <div class="admin-menu" style="padding:16px">
                 <div class="menu-item ${initialTab === 'courses' ? 'active' : ''}" onclick="switchAdminTab('courses', this)" style="margin-bottom:8px">
                    <span class="menu-icon"><i data-lucide="layout-grid"></i></span> Kha Hc
                 </div>
                 <div class="menu-item ${initialTab === 'overview' ? 'active' : ''}" onclick="switchAdminTab('overview', this)" style="margin-bottom:8px">
                    <span class="menu-icon"><i data-lucide="bar-chart-2"></i></span> Thng k
                 </div>
                 <div class="menu-item ${initialTab === 'users' ? 'active' : ''}" onclick="switchAdminTab('users', this)" style="margin-bottom:8px">
                    <span class="menu-icon"><i data-lucide="users"></i></span> Hc vin
                 </div>
                 <div class="menu-item ${initialTab === 'email' ? 'active' : ''}" onclick="switchAdminTab('email', this)" style="margin-bottom:8px">
                    <span class="menu-icon"><i data-lucide="mail"></i></span> Email Mkt
                 </div>
                 <div class="menu-item" onclick="logout()" style="margin-top:24px;color:var(--text-muted)">
                    <span class="menu-icon"><i data-lucide="log-out"></i></span> ng xut
                 </div>
              </div>
              <div class="sidebar-footer" style="margin-top:auto; padding:24px; border-top:1px solid var(--border-light)">
                 <div class="user-mini" style="display:flex; align-items:center; gap:12px">
                    <div class="avatar" style="width:36px; height:36px; background:var(--bg-800); border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--border)">
                       <i data-lucide="user" style="width:16px"></i>
                    </div>
                    <div>
                       <div style="font-weight:600; color:var(--text-primary); font-size:13px">${escapeHtml(state.user.name)}</div>
                       <div style="color:var(--text-muted); font-size:11px">Instructor</div>
                    </div>
                 </div>
              </div>
           </div>
           
           <!-- MAIN CONTENT -->
           <div class="admin-main" style="background:var(--bg-950)">
              <!-- HEADER -->
              <div class="admin-header topbar" style="position:sticky;top:0;z-index:50;padding:16px 32px;height:auto;border-bottom:1px solid var(--border)">
                  <div class="search-wrapper" style="margin:0;width:100%;max-width:400px;background:var(--bg-900)">
                     <div class="search-icon"><i data-lucide="search"></i></div>
                     <input type="text" class="search-input" placeholder="Tm kim nhanh..." oninput="handleSearch(this.value)">
                     <div class="search-dropdown" id="searchDropdown"></div>
                  </div>
                  
                  <div class="header-actions" style="display:flex;gap:12px;margin-left:auto">
                     <div id="adminActionButtons" style="display:flex;gap:12px"></div>
                     <button class="btn-circle" onclick="renderHome(true)"><i data-lucide="rotate-cw"></i></button>
                  </div>
              </div>

              <div class="admin-header" style="padding:0 32px; margin-top:16px; border:none; background:transparent">
                 <div style="font-size:13px;color:#888" id="adminBreadcrumb">Dashboard > ${initialTab === 'overview' ? 'Overview' : initialTab === 'courses' ? 'Kha Hc' : initialTab === 'users' ? 'Hc vin' : 'Email Marketing'}</div>
              </div>
              
              <div class="admin-content" id="adminContent" style="padding:0 32px 32px 32px">
                 <div style="text-align:center;padding:40px;color:#666">Loading...</div>
              </div>
           </div>
           
           <!-- MODAL PROFILE -->
           <div class="profile-modal-overlay" id="modalUserProfile" onclick="if(event.target===this) closeUserProfile()">
              <div class="profile-modal"><div id="userProfileContent"></div></div>
           </div>
           <!-- Include other modals if needed dynamically or reuse global ones -->
        </div>
      `;

      if (window.lucide) lucide.createIcons();

      if (initialTab === 'users') loadAdminUsers();
      else if (initialTab === 'email') loadAdminEmailMarketing();
      else if (initialTab === 'overview') loadAdminOverview();
      else loadAdminCourses();
    }

    function switchAdminTab(tab, el) {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      if (el) el.classList.add('active');

      setUrl({ view: 'dashboard', tab: tab });

      // Clear specific action buttons
      document.getElementById('adminActionButtons').innerHTML = '';

      if (tab === 'overview') {
        document.getElementById('adminBreadcrumb').innerText = 'Dashboard > Overview';
        loadAdminOverview();
      } else if (tab === 'users') {
        document.getElementById('adminBreadcrumb').innerText = 'Dashboard > Hc vin';
        loadAdminUsers();
      } else if (tab === 'email') {
        document.getElementById('adminBreadcrumb').innerText = 'Dashboard > Email Marketing';
        loadAdminEmailMarketing();
      } else if (tab === 'courses') {
        document.getElementById('adminBreadcrumb').innerText = 'Dashboard > Kha Hc';
        loadAdminCourses();
      }
    }

    // NEW: Load Admin Courses logic (reused from Home)
    async function loadAdminCourses() {
      const content = document.getElementById('adminContent');
      // Set up Buttons
      document.getElementById('adminActionButtons').innerHTML = `
          <button class="btn btn-teacher" onclick="openModalQuickAdd()"><i data-lucide="zap" style="width:16px; margin-right:8px"></i> Thm Nhanh</button>
          <button class="btn" style="background:var(--bg-800); border-color:var(--border)" onclick="openModalAddCourse()"><i data-lucide="plus" style="width:16px; margin-right:8px"></i> Th Cng</button>
       `;

      content.innerHTML = `
         <div style="margin-bottom:32px">
             <h2 style="font-size:24px; font-weight:700; margin-bottom:8px">Qun l ni dung</h2>
             <p style="color:var(--text-muted)">Qun l kha hc, bi ging v hc vin ca bn.</p>
         </div>
         <div id="homeGrid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))"></div>
       `;

      if (!state.courses || state.courses.length === 0) {
        content.querySelector('#homeGrid').innerHTML = '<div style="text-align:center;width:100%;grid-column:1/-1">Loading courses...</div>';
        try {
          // Reuse getHomeData to populate state.courses
          const res = await callAPI('getHomeData', {});
          if (Array.isArray(res)) {
            state.courses = res;
            renderCourseGrid(state.courses);
          }
        } catch (e) { console.error(e); }
      } else {
        renderCourseGrid(state.courses);
      }
      if (window.lucide) lucide.createIcons();
    }

    // 2. OVERVIEW TAB
    const DASHBOARD_CACHE_KEY = 'lms_dashboard_cache';
    const DASHBOARD_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in ms

    async function loadAdminOverview(forceRefresh = false) {
      const content = document.getElementById('adminContent');

      // Check localStorage cache first (instant!)
      if (!forceRefresh) {
        const cached = localStorage.getItem(DASHBOARD_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() < parsed.expiry) {
              console.log(' Dashboard from localStorage cache!');
              renderDashboardContent(content, parsed.data, true);
              loadChartDataAsync(); // Still lazy load chart
              return;
            }
          } catch (e) { /* cache invalid, continue */ }
        }
      }

      content.innerHTML = '<div style="text-align:center;margin-top:40px;color:#888"> Loading stats...</div>';

      try {
        // Load stats from API
        const res = await callAPI('getAdminStats', { forceRefresh: forceRefresh });
        if (!res.success) throw new Error(res.message);

        // Save to localStorage
        localStorage.setItem(DASHBOARD_CACHE_KEY, JSON.stringify({
          data: res,
          expiry: Date.now() + DASHBOARD_CACHE_DURATION
        }));

        renderDashboardContent(content, res, false);
        loadChartDataAsync();

      } catch (e) {
        content.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
      }
    }

    // Render Dashboard UI (reusable for cache and fresh data)
    function renderDashboardContent(content, res, fromCache) {
      const s = res.stats;
      const recent = res.recentUsers || [];

      content.innerHTML = `
         <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px">
            <div>
               <h2 style="font-size:24px; font-weight:700; margin:0 0 8px 0; color:var(--text-primary)">Overview</h2>
               <p style="color:var(--text-muted); font-size:13px; margin:0">Track your platform's performance and user activity</p>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
               ${fromCache
          ? `<div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:20px">
                       <i data-lucide="zap" style="width:14px;color:#f97316;fill:currentColor"></i>
                       <span style="font-size:11px;font-weight:700;color:#f97316;text-transform:uppercase;letter-spacing:0.5px">Instant</span>
                     </div>`
          : `<div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:20px">
                       <i data-lucide="check-circle-2" style="width:14px;color:#22c55e"></i>
                       <span style="font-size:11px;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:0.5px">Fresh</span>
                     </div>`}
               <button class="btn btn-red" onclick="loadAdminOverview(true)" style="padding:10px 20px;border-radius:10px;font-weight:700">
                  <i data-lucide="refresh-cw" style="width:14px;margin-right:6px"></i> Refresh
               </button>
            </div>
         </div>
         
         <!-- STATS GRID - ROW 1 -->
         <div class="stats-grid">
            <!-- Card 1: Total Users -->
            <div class="stat-card">
               <div class="stat-icon purple"><i data-lucide="users"></i></div>
               <div class="stat-label">Total Users</div>
               <div class="stat-value">${s.totalUsers}</div>
               <div class="stat-trend"><i data-lucide="user-check" style="width:14px"></i> ${s.approvedUsers || 0} Approved</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill purple" style="width:${Math.round((s.approvedUsers / s.totalUsers) * 100)}%"></div>
               </div>
               <i data-lucide="users" class="stat-icon-bg"></i>
            </div>
            
            <!-- Card 2: Pending Approval -->
            <div class="stat-card">
               <div class="stat-icon yellow"><i data-lucide="clock"></i></div>
               <div class="stat-label">Pending Approval</div>
               <div class="stat-value" style="color:#eab308">${s.pendingUsers || 0}</div>
               <div class="stat-trend"><i data-lucide="hourglass" style="width:14px"></i> Waiting for review</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill yellow" style="width:${s.pendingUsers > 0 ? Math.min((s.pendingUsers / s.totalUsers) * 100, 100) : 0}%"></div>
               </div>
               <i data-lucide="clock" class="stat-icon-bg"></i>
            </div>
            
            <!-- Card 3: Active Learners -->
            <div class="stat-card">
               <div class="stat-icon green"><i data-lucide="activity"></i></div>
               <div class="stat-label">Active Learners</div>
               <div class="stat-value" style="color:#22c55e">${s.activeLearners || 0}</div>
               <div class="stat-trend">
                  <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;display:inline-block;animation:pulse 2s infinite"></span>
                  Currently studying
               </div>
               <div class="stat-progress">
                  <div class="stat-progress-fill green" style="width:${s.activeLearners > 0 ? Math.round((s.activeLearners / s.totalUsers) * 100) : 0}%"></div>
               </div>
               <i data-lucide="target" class="stat-icon-bg"></i>
            </div>
            
            <!-- Card 4: Total Courses -->
            <div class="stat-card">
               <div class="stat-icon blue"><i data-lucide="book"></i></div>
               <div class="stat-label">Total Courses</div>
               <div class="stat-value">${s.totalCourses}</div>
               <div class="stat-trend"><i data-lucide="bookmark" style="width:14px"></i> ${s.totalLessons || 0} Lessons</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill blue" style="width:100%"></div>
               </div>
               <i data-lucide="layers" class="stat-icon-bg"></i>
            </div>
         </div>
         
         <!-- STATS GRID - ROW 2 -->
         <div class="stats-grid" style="margin-top:16px">
            <!-- Completed Lessons (Compact with circular progress simulation) -->
            <div class="stat-card" style="background:var(--bg-800)">
               <div class="stat-icon red"><i data-lucide="trophy"></i></div>
               <div class="stat-label">Completed Lessons</div>
               <div class="stat-value" style="color:var(--brand-red)">${s.completedLessons}</div>
               <div class="stat-trend"><i data-lucide="check-circle" style="width:14px"></i> Learning Progress</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill red" style="width:0%"></div>
               </div>
               <i data-lucide="award" class="stat-icon-bg"></i>
            </div>
            
            <!-- User Growth Chart (Spanning 3 columns) -->
            <div class="stat-card" style="grid-column: span 3; background:var(--bg-800); border-color:var(--border)">
               <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                  <div style="display:flex; align-items:center; gap:12px">
                     <div style="width:4px; height:24px; background:var(--brand-red); border-radius:2px"></div>
                     <div class="stat-label" style="margin:0; font-size:14px; letter-spacing:1px">USER GROWTH</div>
                  </div>
                  <div style="display:flex;gap:8px">
                     <button class="btn-sm chart-period active" data-period="7" onclick="updateChartPeriod(7, this)">7 Days</button>
                     <button class="btn-sm chart-period" data-period="30" onclick="updateChartPeriod(30, this)">30 Days</button>
                     <button class="btn-sm chart-period" data-period="90" onclick="updateChartPeriod(90, this)">90 Days</button>
                  </div>
               </div>
               <div style="height:200px;position:relative" id="chartContainer">
                  <div style="text-align:center;padding:60px;color:#666"> Loading chart...</div>
               </div>
            </div>
         </div>
         
         <!-- RECENT USERS -->
         <div class="table-card" style="margin-top:24px">
            <div class="table-header" style="margin-bottom:24px">
               <div class="table-title" style="font-size:14px; font-weight:700; text-transform:uppercase; letter-spacing:1px">Recently Joined Users</div>
               <button class="btn-sm" onclick="switchAdminTab('users', document.querySelectorAll('.menu-item')[1])" style="display:flex;align-items:center;gap:8px;background:var(--bg-800);border-color:var(--border)">
                  View All <i data-lucide="arrow-right" style="width:14px"></i>
               </button>
            </div>
            <table class="data-table" style="width:100%">
               <thead>
                  <tr style="border-bottom:1px solid var(--border)">
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Name</th>
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Email</th>
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Status</th>
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Joined</th>
                     <th style="text-align:right;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Action</th>
                  </tr>
               </thead>
               <tbody>
                  ${recent.map(u => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background=''">
                       <td style="padding:16px">
                          <div style="display:flex;align-items:center;gap:12px">
                             <div style="width:40px;height:40px;border-radius:50%;background:var(--bg-700);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--text-primary)">
                                ${String(u.name || '').charAt(0).toUpperCase()}
                             </div>
                             <span style="font-weight:600;color:var(--text-primary);transition:color 0.2s" onmouseover="this.style.color='var(--brand-red)'" onmouseout="this.style.color='var(--text-primary)'">
                                ${escapeHtml(u.name)}
                             </span>
                          </div>
                       </td>
                       <td style="padding:16px;color:var(--text-secondary);font-size:13px">${escapeHtml(u.email)}</td>
                       <td style="padding:16px">
                          <span class="status-badge ${u.status === 'Approve' ? 'status-active' : 'status-inactive'}" style="padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;
                             ${u.status === 'Approve'
              ? 'background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.2)'
              : 'background:rgba(234,179,8,0.1);color:#eab308;border:1px solid rgba(234,179,8,0.2)'}">
                             ${u.status === 'Approve' ? 'Approved' : 'Pending'}
                          </span>
                       </td>
                       <td style="padding:16px;color:var(--text-muted);font-size:12px;font-family:monospace">${escapeHtml(u.joinedDate)}</td>
                       <td style="padding:16px;text-align:right">
                          <button class="btn-sm" onclick="viewUserProfile('${u.email}')" style="padding:8px 12px;background:var(--bg-800);border-color:var(--border)">
                             <i data-lucide="eye" style="width:14px"></i>
                          </button>
                       </td>
                    </tr>
                  `).join('')}
               </tbody>
            </table>
         </div>
       `;

      // Initialize Lucide icons
      if (window.lucide) lucide.createIcons();
    }

    // Lazy load chart data with localStorage cache
    const CHART_CACHE_KEY = 'lms_chart_cache';
    async function loadChartDataAsync() {
      try {
        // Check localStorage cache first
        const cached = localStorage.getItem(CHART_CACHE_KEY);
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Date.now() < parsed.expiry) {
            renderChart(parsed.data);
            return;
          }
        }

        const chartRes = await callAPI('getAdminChartData', {});
        if (chartRes.success) {
          localStorage.setItem(CHART_CACHE_KEY, JSON.stringify({
            data: chartRes.userGrowth || [],
            expiry: Date.now() + DASHBOARD_CACHE_DURATION
          }));
          renderChart(chartRes.userGrowth || []);
        }
      } catch (e) {
        console.error('Chart load error:', e);
      }
    }

    function renderChart(data) {
      const container = document.getElementById('chartContainer');
      if (container) {
        container.innerHTML = '<canvas id="userGrowthChart"></canvas>';
        window.userGrowthData = data;
        initUserGrowthChart(data, 7);
      }
    }

    // Chart Helper Functions
    let userGrowthChartInstance = null;

    function initUserGrowthChart(data, days) {
      const ctx = document.getElementById('userGrowthChart');
      if (!ctx) return;

      // Filter data to last N days
      const now = new Date();
      const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      const filtered = data.filter(d => new Date(d.date) >= cutoff);

      // Generate labels for the period (fill missing dates with 0)
      const labels = [];
      const counts = [];
      const dataMap = {};
      filtered.forEach(d => dataMap[d.date] = d.count);

      for (let i = days - 1; i >= 0; i--) {
        const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const key = d.toISOString().split('T')[0];
        labels.push(d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
        counts.push(dataMap[key] || 0);
      }

      // Destroy existing chart
      if (userGrowthChartInstance) {
        userGrowthChartInstance.destroy();
      }

      userGrowthChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'New Users',
            data: counts,
            borderColor: '#e50914',
            backgroundColor: 'rgba(229, 9, 20, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: '#e50914'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888', font: { size: 10 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888', stepSize: 1 }
            }
          }
        }
      });
    }

    function updateChartPeriod(days, btn) {
      document.querySelectorAll('.chart-period').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      initUserGrowthChart(window.userGrowthData || [], days);
    }

    // 3. USERS TAB
    const USERS_CACHE_KEY = 'lms_users_cache';

    async function loadAdminUsers(forceRefresh = false) {
      const content = document.getElementById('adminContent');

      // Check localStorage cache first
      if (!forceRefresh) {
        const cached = localStorage.getItem(USERS_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() < parsed.expiry) {
              console.log(' Users from localStorage cache!');
              renderUsersContent(content, parsed.data, true);
              return;
            }
          } catch (e) { /* cache invalid */ }
        }
      }

      content.innerHTML = '<div style="text-align:center;margin-top:40px;color:#888"> Loading users...</div>';

      try {
        const res = await callAPI('getAllStudents', {});
        if (!res.success) throw new Error(res.message);

        // Save to cache
        localStorage.setItem(USERS_CACHE_KEY, JSON.stringify({
          data: res,
          expiry: Date.now() + DASHBOARD_CACHE_DURATION
        }));

        renderUsersContent(content, res, false);

      } catch (e) {
        content.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
      }
    }

    function renderUsersContent(content, res, fromCache) {
      const users = res.students || [];

      content.innerHTML = `
         <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
            <div class="admin-title" style="margin:0">User Management</div>
            <div style="display:flex;align-items:center;gap:12px">
               ${fromCache ? '<span style="color:#888;font-size:12px"> Instant</span>' : '<span style="color:#4ade80;font-size:12px"> Fresh</span>'}
               <input type="text" class="search-input" style="width:200px;margin:0" placeholder="Search user..." oninput="filterUserTable(this.value)">
               <button class="btn-sm" style="background:#22c55e;color:white;border:none" onclick="openModalAddUserDirect()">
                  <i data-lucide="user-plus" style="width:14px;margin-right:4px"></i> Add
               </button>
               <button class="btn-sm btn-red" onclick="loadAdminUsers(true)"> Refresh</button>
            </div>
         </div>
         
         <div class="table-card">
            <table class="data-table" id="userTable">
               <thead>
                  <tr>
                     <th>Name</th>
                     <th>Email</th>
                     <th>Phone</th>
                     <th>Role</th>
                     <th>Status</th>
                     <th>Actions</th>
                  </tr>
               </thead>
               <tbody>
                  ${users.map(u => `
                    <tr class="user-row">
                       <td style="display:flex;align-items:center;gap:12px">
                          <div class="profile-avatar" style="width:32px;height:32px;font-size:12px;border-width:1px">${String(u.name || '').charAt(0)}</div>
                          <span class="u-name">${escapeHtml(u.name)}</span>
                       </td>
                       <td class="u-email">${escapeHtml(u.email)}</td>
                       <td class="u-phone">${escapeHtml(u.phone)}</td>
                       <td>${escapeHtml(u.role)}</td>
                       <td>
                          <span class="status-badge ${u.status === 'Locked' ? 'status-inactive' : 'status-active'}">${u.status}</span>
                       </td>
                       <td style="display:flex;gap:8px">
                          <button class="btn-sm" onclick="viewUserProfile('${u.email}')"> View</button>
                          <button class="btn-sm" onclick="toggleLockUser('${u.email}', '${u.status}')" style="color:${u.status === 'Locked' ? '#4caf50' : '#f44336'}">
                             ${u.status === 'Locked' ? ' Unlock' : ' Lock'}
                          </button>
                       </td>
                    </tr>
                  `).join('')}
               </tbody>
            </table>
         </div>
       `;
    }

    // Filter Helper
    function filterUserTable(keyword) {
      const rows = document.querySelectorAll('.user-row');
      keyword = keyword.toLowerCase();
      rows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = text.includes(keyword) ? '' : 'none';
      });
    }

    // 4. VIEW PROFILE & ACTIONS
    async function viewUserProfile(email) {
      const modal = document.getElementById('modalUserProfile');
      const body = document.getElementById('userProfileContent');
      modal.classList.add('active');
      body.innerHTML = '<div style="padding:40px;text-align:center;color:#fff">Loading details...</div>';

      try {
        const res = await callAPI('getStudentDetails', { email });
        if (!res.success) throw new Error(res.message);

        const u = res.user;
        const statusClass = 'status-active'; // Default
        const statusText = 'Verified';

        body.innerHTML = `
             <div class="profile-header">
                <div class="profile-avatar">${u.name.charAt(0)}</div>
                <div class="profile-info">
                   <h2>${escapeHtml(u.name)}</h2>
                   <p>@${u.email.split('@')[0]}</p>
                </div>
                <span class="status-badge ${statusClass}" style="margin-left:auto">${statusText}</span>
             </div>
             
             <div class="profile-body">
                <div class="profile-grid">
                   <div class="info-card">
                      <span class="info-label">Verification Status</span>
                      <span class="info-value" style="color:#4caf50">Verified</span>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Phone</span>
                      <span class="info-value">${escapeHtml(u.phone)}</span>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Country</span>
                      <span class="info-value">Vietnam </span>
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Account Details</h3>
                <div class="profile-grid">
                   <div class="info-card">
                       <span class="info-label">Email</span>
                       <span class="info-value">${escapeHtml(u.email)}</span>
                   </div>
                   <div class="info-card">
                       <span class="info-label">Enrolled Courses</span>
                       <span class="info-value">${u.coursesCount} Courses</span>
                   </div>
                   <div class="info-card">
                       <span class="info-label">Completed Lessons</span>
                       <span class="info-value">${u.completedLessons} Lessons</span>
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Actions</h3>
                <div style="display:flex;gap:12px">
                   <button class="btn-sm" style="padding:10px 20px;background:#333" onclick="adminResetPass('${u.email}')"> Reset Password</button>
                   <button class="btn-sm" style="padding:10px 20px;background:#333;color:#f44336" onclick="closeUserProfile()">Close</button>
                </div>
             </div>
          `;
      } catch (e) {
        body.innerHTML = `<div style="padding:20px;color:red">Error: ${e.message}</div>`;
      }
    }

    function closeUserProfile() {
      document.getElementById('modalUserProfile').classList.remove('active');
    }

    async function toggleLockUser(email, currentStatus) {
      const newStatus = currentStatus === 'Locked' ? 'Active' : 'Locked';
      if (!confirm(`Are you sure you want to ${newStatus} this user?`)) return;

      showToast('Updating status...', 'info');
      const res = await callAPI('updateStudentStatus', { email, status: newStatus });
      if (res.success) {
        showToast('Updated successfully!', 'success');
        loadAdminUsers(); // Reload table
      } else {
        showToast(res.message, 'error');
      }
    }

    async function adminResetPass(email) {
      if (!confirm(`Reset password for ${email} to default '123456'?`)) return;
      showToast('Resetting password...', 'info');
      const res = await callAPI('adminResetStudentPass', { email });
      if (res.success) {
        showToast('Password reset successfully!', 'success');
      } else {
        showToast(res.message, 'error');
      }
    }

    // 5. PERSONAL PROFILE
    function openPersonalProfile() {
      const modal = document.getElementById('modalUserProfile');
      const body = document.getElementById('userProfileContent');
      modal.classList.add('active');

      const u = state.user;
      // Assuming u.phone is available. If not, might need to fetchProfile first or rely on login data.
      const phone = u.phone || '';

      body.innerHTML = `
          <div class="profile-header">
             <div class="profile-avatar">${u.name.charAt(0)}</div>
             <div class="profile-info">
                <h2>${escapeHtml(u.name)}</h2>
                <p>@${u.email.split('@')[0]}</p>
             </div>
             <span class="status-badge status-active" style="margin-left:auto">Personal Mode</span>
          </div>
          
          <div class="profile-body">
             <form id="formProfile" onsubmit="handleUpdateProfile(event)">
                <div class="profile-grid">
                   <div class="info-card">
                      <span class="info-label">Email (Read-only)</span>
                      <input type="text" class="form-input" style="background:#333;color:#888" value="${escapeHtml(u.email)}" disabled>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Full Name</span>
                      <input type="text" class="form-input" id="pName" style="background:#111;color:#fff;border:1px solid #333" value="${escapeHtml(u.name)}" required>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Phone Number</span>
                      <input type="tel" class="form-input" id="pPhone" style="background:#111;color:#fff;border:1px solid #333" value="${escapeHtml(phone)}">
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Change Password (Optional)</h3>
                <div class="profile-grid">
                   <div class="info-card">
                       <span class="info-label">Old Password</span>
                       <input type="password" class="form-input" id="pOldPass" style="background:#111;color:#fff;border:1px solid #333" placeholder="Required if changing pass">
                   </div>
                   <div class="info-card">
                       <span class="info-label">New Password</span>
                       <input type="password" class="form-input" id="pNewPass" style="background:#111;color:#fff;border:1px solid #333" placeholder="Leave empty to keep current">
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Actions</h3>
                <div style="display:flex;gap:12px">
                   <button type="submit" class="btn-sm" style="padding:10px 24px;background:var(--admin-accent);font-size:14px"> Save Changes</button>
                   <button type="button" class="btn-sm" style="padding:10px 24px;background:#333;font-size:14px" onclick="closeUserProfile()">Cancel</button>
                </div>
             </form>
          </div>
       `;
    }

    async function handleUpdateProfile(e) {
      e.preventDefault();

      const name = document.getElementById('pName').value.trim();
      const phone = document.getElementById('pPhone').value.trim();
      const oldPass = document.getElementById('pOldPass').value;
      const newPass = document.getElementById('pNewPass').value;

      if (newPass && !oldPass) {
        showToast('Vui lng nhp mt khu c  i mt khu!', 'warning');
        return;
      }

      showToast('ang cp nht...', 'info');

      const res = await callAPI('updateUserProfile', {
        email: state.user.email,
        name: name,
        phone: phone,
        oldPass: oldPass,
        newPass: newPass
      });

      if (res.success) {
        showToast('Cp nht thnh cng!', 'success');
        // Update local state
        state.user.name = name;
        state.user.phone = phone;
        localStorage.setItem('lms_user', JSON.stringify(state.user));

        closeUserProfile();
        renderHome(); // Refresh UI
      } else {
        showToast('Li: ' + res.message, 'error');
      }
    }

    // 6. EMAIL MARKETING & AUTOMATION - Updated with Analytics
    let emailRecipients = []; // Global store for recipients
    let excludedEmails = []; // Emails to exclude

    async function loadAdminEmailMarketing() {
      console.log(' [EmailMkt] Loading Email Marketing tab...');
      const content = document.getElementById('adminContent');
      content.innerHTML = renderEmailMarketingUI();
      if (window.lucide) lucide.createIcons();

      // Load real stats
      await loadEmailStats();

      // Check auto reminder status
      try {
        const res = await callAPI('getAutoReminderStatus', {});
        if (res.success) {
          const toggle = document.getElementById('autoReminderToggle');
          if (toggle) toggle.checked = res.isActive;
        }
      } catch (e) { console.error(e); }

      // Setup filter change listener
      document.getElementById('emailFilter').addEventListener('change', loadRecipientPreview);

      // Load initial preview
      await loadRecipientPreview();

      // Load Email Configuration (Drive Folder, etc.)
      await loadEmailConfiguration();

      // Initialize Quill Rich Text Editor (Main)
      initEmailEditor();

      // Initialize Quill for Reminder
      if (document.getElementById('reminderEditor')) {
        window.quillReminder = new Quill('#reminderEditor', {
          theme: 'snow',
          placeholder: 'Ni dung nhc nh...',
          modules: { toolbar: [['bold', 'italic'], ['link', 'image']] }
        });
      }

      // Load Reminder Settings
      await loadAutoReminderSettings();
    }

    let quillEditor = null;
    function initEmailEditor() {
      console.log(' [EmailMkt] Initializing Quill editor...');
      const container = document.getElementById('emailEditor');
      if (!container) {
        console.error(' [EmailMkt] emailEditor container not found');
        return;
      }

      quillEditor = new Quill('#emailEditor', {
        theme: 'snow',
        placeholder: 'Hi {{name}},\n\nNi dung email ca bn...',
        modules: {
          toolbar: {
            container: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['link', 'image'],
              ['clean']
            ],
            handlers: {
              'image': function () {
                // Custom image handler: trigger file input
                const fileInput = document.getElementById('quillImageInput');
                if (fileInput) fileInput.click();
              }
            }
          }
        }
      });

      // Set default content
      quillEditor.root.innerHTML = '<p>Hi {{name}},</p><p><br></p><p>Ni dung email ca bn...</p>';

      console.log(' [EmailMkt] Quill editor initialized');
    }

    function getEmailContent() {
      if (quillEditor) {
        return quillEditor.root.innerHTML;
      }
      return '';
    }

    async function loadEmailStats() {
      console.log(' [EmailMkt] Loading stats...');
      try {
        const res = await callAPI('getEmailStats', {});
        console.log(' [EmailMkt] Stats loaded:', res);

        if (res.success) {
          document.getElementById('statTotalAllTime').innerText = res.totalAllTime || 0;
          document.getElementById('statSentToday').innerText = res.sentToday || 0;
          document.getElementById('statQuotaRemaining').innerText = res.remainingQuota || '--';
          document.getElementById('statAvgOpenRate').innerText = (res.avgOpenRate || 0) + '%';

          // Render campaign history
          if (window.renderCampaignHistory) {
            renderCampaignHistory(res.campaigns || []);
          }
        }
      } catch (e) {
        console.error(' [EmailMkt] Error loading stats:', e);
      }
    }

    function renderCampaignHistory(campaigns) {
      const container = document.getElementById('campaignHistoryBody'); // Need to ensure this ID exists in HTML, otherwise use querySelector
      // If container not found, maybe rewrite the table container
      const tableContainer = document.querySelector('.campaign-history-table');

      // Let's assume we need to replace the content of "Campaign History" section
      // Finding the section by class or hierarchy if ID is missing is risky.
      // Better to have a dedicated container.
      // I will look for where 'Campaign History' text is to identify the container in next steps or inject ID.
      // For now, I'll define logic assuming there is a container `campaignListTableBody`.

      const tbody = document.getElementById('campaignHistoryBody');
      if (!tbody) return;

      if (!campaigns || campaigns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:20px;text-align:center;color:#666">No campaigns yet.</td></tr>';
        return;
      }

      let html = '';
      campaigns.forEach(c => {
        let rateColor = '#666';
        const rate = parseFloat(c.openRate);
        if (rate > 50) rateColor = '#22c55e';
        else if (rate > 20) rateColor = '#eab308';

        const timeDisplay = c.time.split(',')[0]; // Simple date

        html += `
             <tr style="border-bottom:1px solid #1f1f23; font-size:13px">
                <td style="padding:12px;color:var(--text-muted)">${timeDisplay}</td>
                <td style="padding:12px;color:white;font-weight:500">${c.subject}</td>
                <td style="padding:12px;text-align:center;color:var(--text-muted)">${c.recipientCount}</td>
                <td style="padding:12px;text-align:right;font-weight:700;color:${rateColor}">${c.openRate}%</td>
                <td style="padding:12px;text-align:right">
                    <button class="btn-sm" onclick="openCampaignDetail('${c.id}')" style="background:#27272a;border:none;color:white;padding:4px 8px;font-size:11px">
                       Details
                    </button>
                </td>
             </tr>
         `;
      });
      tbody.innerHTML = html;
    }

    // Open Detail Modal
    async function openCampaignDetail(cid) {
      console.log(' [Frontend] openCampaignDetail called with CID:', cid);
      if (!document.getElementById('modalCampaignDetail')) {
        createCampaignDetailModal();
      }
      document.getElementById('modalCampaignDetail').style.display = 'flex';
      const container = document.getElementById('detailListContainer');
      container.innerHTML = '<div style="padding:20px;text-align:center">Loading viewers...</div>';

      try {
        console.log(' [Frontend] Calling API getCampaignViewers...');
        const res = await callAPI('getCampaignViewers', { campaignId: cid });
        console.log(' [Frontend] API Response:', res);

        if (res.success) {
          renderDetailViewers(res.viewers);
        } else {
          console.error(' [Frontend] API returned success:false', res.message);
          container.innerHTML = `<div style="color:#ef4444;padding:20px;text-align:center">Error: ${res.message || 'Unknown error'}</div>`;
        }
      } catch (e) {
        console.error(' [Frontend] Exception:', e);
        container.innerHTML = 'Error: ' + e.message;
      }
    }

    function renderDetailViewers(viewers) {
      const container = document.getElementById('detailListContainer');
      if (!viewers || viewers.length === 0) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#666">No one has opened this email yet.</div>';
        return;
      }

      let html = `
    <div style="margin-bottom:10px;font-size:12px;color:var(--text-muted)">Total Unique Opens: <strong style="color:white">${viewers.length}</strong></div>
    <table style="width:100%;font-size:13px;color:var(--text-primary);border-collapse:collapse">
        <thead>
            <tr style="border-bottom:1px solid #27272a;text-align:left">
                <th style="padding:8px;color:var(--text-muted)">Email User</th>
                <th style="padding:8px;color:var(--text-muted);text-align:right">Last Open</th>
            </tr>
        </thead>
        <tbody>
    `;

      viewers.forEach(v => {
        html += `
        <tr style="border-bottom:1px solid #1f1f23">
            <td style="padding:8px;color:#3b82f6">${v.email}</td>
            <td style="padding:8px;text-align:right;color:var(--text-muted)">${v.lastOpen}</td>
        </tr>
        `;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function createCampaignDetailModal() {
      const html = `
    <div id="modalCampaignDetail" class="modal-overlay-2" style="display:none;z-index:99999; justify-content:center; align-items:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8)">
       <div class="report-card" style="width:500px;max-width:95vw;max-height:80vh;display:flex;flex-direction:column;padding:0;background:#121216;border:1px solid #27272a;box-shadow:0 20px 50px rgba(0,0,0,0.5);border-radius:12px">
          <div style="padding:16px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center;background:#18181b">
             <h3 style="margin:0;color:white;font-size:15px">Campaign Viewers</h3>
             <button onclick="document.getElementById('modalCampaignDetail').style.display='none'" style="background:none;border:none;color:#52525b;cursor:pointer"><i data-lucide="x"></i></button>
          </div>
          <div style="flex:1;overflow-y:auto;padding:16px">
             <div id="detailListContainer"></div>
          </div>
       </div>
    </div>
    `;
      document.body.insertAdjacentHTML('beforeend', html);
      lucide.createIcons();
    }

    function renderEmailMarketingUI() {
      return `
        <div style="max-width:1000px; margin:0 auto">
          <div style="margin-bottom:24px">
            <h2 class="admin-title" style="margin-bottom:8px">Email Marketing & Automation</h2>
            <div style="color:var(--text-muted)">Send announcements or set up automated reminders.</div>
          </div>

          <!-- Stats Cards (Dynamic) -->
          <div class="stats-grid" style="grid-template-columns:repeat(4,1fr); margin-bottom:32px">
             <div class="stat-card" style="padding:16px">
                <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase">Total Sent (All Time)</div>
                <div id="statTotalAllTime" style="font-size:24px;font-weight:700;color:white">--</div>
             </div>
             <div class="stat-card" style="padding:16px">
                <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase">Sent Today</div>
                <div id="statSentToday" style="font-size:24px;font-weight:700;color:#22c55e">--</div>
             </div>
             <div class="stat-card" style="padding:16px">
                <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase">Quota Remaining</div>
                <div id="statQuotaRemaining" style="font-size:24px;font-weight:700;color:#3b82f6">--</div>
             </div>
             <div class="stat-card" style="padding:16px">
                <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase">Open Rate (Avg)</div>
                <div id="statAvgOpenRate" style="font-size:24px;font-weight:700;color:var(--warning)">--</div>
             </div>
          </div>
          
          <!-- Settings & Configuration -->
          <div class="stat-card" style="margin-bottom:24px; padding:20px; flex-direction:row; align-items:center; gap:20px; flex-wrap:wrap">
             <div style="flex:1; min-width:300px">
                <h3 style="margin:0 0 6px 0; font-size:16px; color:white">Email Configuration <span style="font-size:11px;color:#22c55e">(v2.2 Debug)</span></h3>
                <div style="font-size:13px; color:var(--text-muted)">Cu hnh th mc Google Drive  lu nh khi upload trong editor.</div>
             </div>
             <div style="flex:2; display:flex; gap:12px; min-width:300px">
                <div style="display:flex; align-items:flex-end; gap:12px">
                   <div style="flex:1">
                      <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">Email Configuration</label>
                       <button class="btn" onclick="openEmailSettingsModal()" style="width:100%;background:var(--bg-700);border:1px solid var(--border);color:white;justify-content:center">
                          <i data-lucide="settings" style="width:14px;margin-right:6px"></i> Open Email Editor
                       </button>
                   </div>
                </div>
             </div>
          </div>
          
          <!-- Hidden File Input for Quill -->
          <input type="file" id="quillImageInput" style="display:none" accept="image/*" onchange="handleQuillImageUpload(this)">

          <div style="display:grid;grid-template-columns:1fr 320px;gap:24px">
            <!-- Left: Campaign Form -->
            <div class="stat-card">
               <div style="border-bottom:1px solid var(--border); padding-bottom:16px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                  <h3 style="margin:0; font-size:18px; color:white">New Campaign</h3>
               </div>
               
               <!-- Test Email Section -->
               <div style="background:var(--bg-900);border-radius:8px;padding:16px;margin-bottom:20px;border:1px solid var(--border)">
                  <div style="display:flex;gap:12px;align-items:flex-end">
                     <div style="flex:1">
                        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px">Test Email (Send test before launching)</label>
                        <input type="email" id="testEmailInput" class="form-input" placeholder="your@email.com" style="background:var(--bg-800)">
                     </div>
                     <button class="btn" onclick="handleSendTestEmail()" style="background:var(--bg-700);border:1px solid var(--border);white-space:nowrap">
                        <i data-lucide="mail-check" style="width:14px;margin-right:6px"></i> Send Test
                     </button>
                  </div>
               </div>
               
               <div class="form-group" style="background:var(--bg-800); padding:16px; border-radius:8px; border:1px solid var(--border)">
                  <label class="form-label" style="color:var(--brand-red)">1. Select Recipients</label>
                  
                  <select id="emailFilterType" class="form-input" style="background:var(--bg-900);margin-bottom:12px" onchange="handleFilterTypeChange()">
                     <option value="all"> All Students (Default)</option>
                     <option value="inactive"> Inactive Students (Ghost User)</option>
                     <option value="course"> Students by Course</option>
                  </select>
                  
                  <!-- Dynamic Config Area -->
                  <div id="filterConfigArea" style="padding-left:12px; border-left:2px solid var(--border); display:none"></div>
               </div>

               <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                  <div class="form-group" style="margin-bottom:0">
                     <label class="form-label">Sender Name</label>
                     <input type="text" id="emailSenderName" class="form-input" placeholder="VD: AZ English Academy" value="AZ English Academy">
                  </div>
                  <div class="form-group" style="margin-bottom:0">
                     <label class="form-label">Subject</label>
                     <input type="text" id="emailSubject" class="form-input" placeholder="Enter subject...">
                  </div>
               </div>
               
               <div class="form-group" style="margin-top:16px">
                  <label class="form-label">Email Content</label>
                  <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px">Variable: <code>{{name}}</code>, <code>{{days}}</code></div>
                  <div id="emailEditorContainer" style="background:var(--bg-900);border:1px solid var(--border);border-radius:8px;overflow:hidden">
                     <div id="emailEditor" style="height:200px;color:var(--text-primary)"></div>
                  </div>
               </div>
               
               <!-- Action Area -->
               <div style="background:var(--bg-800); padding:16px; border-radius:8px; border:1px solid var(--border)">
                   <label class="form-label" style="color:#22c55e">2. Schedule & Send</label>
                   
                   <div style="display:flex; gap:16px; margin-bottom:12px">
                       <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                          <input type="radio" name="sendMode" value="now" checked onchange="toggleSchedule(false)"> 
                          <span> Send Now</span>
                       </label>
                       <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                          <input type="radio" name="sendMode" value="schedule" onchange="toggleSchedule(true)"> 
                          <span> Schedule</span>
                       </label>
                   </div>
                   
                   <div id="scheduleOptions" style="display:none; margin-bottom:16px; padding:12px; background:var(--bg-900); border-radius:6px">
                       <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                           <div>
                              <label class="form-label" style="font-size:11px">Start Date & Time</label>
                              <input type="datetime-local" id="scheduleTime" class="form-input">
                           </div>
                           <div>
                              <label class="form-label" style="font-size:11px">Recurrence</label>
                              <select id="scheduleRecurrence" class="form-input">
                                  <option value="ONCE">One time only</option>
                                  <option value="DAILY">Daily (Every day at this time)</option>
                                  <option value="WEEKLY">Weekly (Every week)</option>
                                  <option value="MONTHLY">Monthly</option>
                              </select>
                           </div>
                       </div>
                   </div>

                   <button class="btn btn-red" onclick="handleSendCampaign()" id="btnAction" style="width:100%; justify-content:center">
                      <i data-lucide="send" style="width:16px; margin-right:8px"></i> Execute Campaign
                   </button>
               </div>
            </div>
            
            <!-- Right: Recipient Preview -->
            <div class="stat-card" style="padding:0;display:flex;flex-direction:column;max-height:500px">
               <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                  <div>
                     <h4 style="margin:0;font-size:14px;color:white">Recipients</h4>
                     <div style="font-size:12px;color:var(--text-muted)"><span id="recipientCount">0</span> users in list</div>
                  </div>
                  <div style="display:flex;gap:8px">
                     <button class="btn-sm" style="font-size:11px;padding:4px 8px" onclick="selectAllRecipients(true)">Select All</button>
                     <button class="btn-sm" style="font-size:11px;padding:4px 8px;background:transparent;border:1px solid var(--border)" onclick="selectAllRecipients(false)">Deselect</button>
                  </div>
               </div>
               <div id="recipientPreviewList" style="flex:1;overflow-y:auto">
                  <div style="text-align:center;padding:20px;color:var(--text-muted)">Loading...</div>
               </div>
            </div>
          </div>

          <!-- Automation -->
          <div class="stat-card" style="margin-top:24px; padding:24px; flex-direction:row; align-items:center; justify-content:space-between">
             <div>
                <h3 style="margin:0 0 4px 0; font-size:16px; color:white">Inactive Student Reminder</h3>
                <div style="font-size:13px; color:var(--text-muted)">Automatically send email if inactive for 7 days (Runs daily at 9:00 AM)</div>
             </div>
             <label class="switch" style="position:relative; display:inline-block; width:48px; height:24px">
                <input type="checkbox" id="autoReminderToggle" onchange="handleToggleAutoReminder(this)" style="opacity:0; width:0; height:0">
                <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#333; transition:.4s; border-radius:34px" 
                      class="slider"></span>
                <span style="position:absolute; content:''; height:18px; width:18px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2)"
                      class="slider-thumb"></span>
             </label>
             <style>
               #autoReminderToggle:checked + .slider { background-color: #22c55e; }
               #autoReminderToggle:checked + .slider .slider-thumb { transform: translateX(24px); }
             </style>
          </div>
          
          <!-- Campaign History -->
          <div class="stat-card" style="margin-top:24px;">
             <div style="border-bottom:1px solid var(--border); padding-bottom:16px; margin-bottom:16px">
                <h3 style="margin:0; font-size:18px; color:white">Campaign History</h3>
             </div>
             <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                   <thead>
                      <tr style="border-bottom:1px solid var(--border)">
                         <th style="padding:12px;text-align:left;color:var(--text-muted);font-size:12px;text-transform:uppercase">Time</th>
                         <th style="padding:12px;text-align:left;color:var(--text-muted);font-size:12px;text-transform:uppercase">Subject</th>
                         <th style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;text-transform:uppercase">Recipients</th>
                         <th style="padding:12px;text-align:right;color:var(--text-muted);font-size:12px;text-transform:uppercase">Open Rate</th>
                         <th style="padding:12px;text-align:right;color:var(--text-muted);font-size:12px;text-transform:uppercase">Msg</th>
                      </tr>
                   </thead>
                   <tbody id="campaignHistoryBody">
                      <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px">Loading...</td></tr>
                   </tbody>
                </table>
             </div>
          </div>
        </div>
      `;
    }

    function selectAllRecipients(selectAll) {
      const checkboxes = document.querySelectorAll('.recipient-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = selectAll;
      });
      excludedEmails = selectAll ? [] : emailRecipients.map(r => r.email);
      const remaining = selectAll ? emailRecipients.length : 0;
      document.getElementById('selectedCount').textContent = remaining;
    }

    // Removed duplicate renderCampaignHistory function to use the new one defined earlier.



    async function handleSendTestEmail() {
      const testEmail = document.getElementById('testEmailInput').value;
      const senderName = document.getElementById('emailSenderName').value || 'LMS System';
      const subject = document.getElementById('emailSubject').value;
      const body = getEmailContent();

      if (!testEmail) {
        showToast('Vui lng nhp email  test', 'warning');
        return;
      }
      if (!subject || !body || body === '<p><br></p>') {
        showToast('Vui lng nhp Subject v Ni dung email trc', 'warning');
        return;
      }

      console.log(' [EmailMkt] Sending test email to:', testEmail, 'from:', senderName);
      showToast('ang gi test email...', 'info');

      try {
        const res = await callAPI('sendTestEmail', { testEmail, senderName, subject, bodyTemplate: body });
        console.log(' [EmailMkt] Test email result:', res);

        if (res.success) {
          showToast(res.message, 'success');
        } else {
          showToast(res.message, 'error');
        }
      } catch (e) {
        console.error(' [EmailMkt] Test email error:', e);
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function handleSendBatchEmail() {
      const filter = document.getElementById('emailFilter').value;
      const senderName = document.getElementById('emailSenderName').value || 'LMS System';
      const subject = document.getElementById('emailSubject').value;
      const body = getEmailContent();
      const actualRecipients = emailRecipients.length - excludedEmails.length;

      if (!subject || !body || body === '<p><br></p>') {
        showToast('Vui lng in Subject v Ni dung email', 'warning');
        return;
      }

      if (actualRecipients <= 0) {
        showToast('Khng c ngi nhn no c chn!', 'warning');
        return;
      }

      if (!confirm(`Gi email ti ${actualRecipients} ngi (loi tr ${excludedEmails.length})?`)) return;

      console.log(' [EmailMkt] Sending campaign:', { filter, senderName, actualRecipients, excludedCount: excludedEmails.length });

      const btn = document.getElementById('btnSendMail');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="loader"></i> Sending...';

      try {
        const res = await callAPI('sendBatchEmail', {
          filterType: filter,
          senderName: senderName,
          subject: subject,
          bodyTemplate: body,
          excludedEmails: excludedEmails
        });

        console.log(' [EmailMkt] Campaign result:', res);

        if (res.success) {
          showToast(res.message, 'success', 5000);
          document.getElementById('emailSubject').value = '';
          if (quillEditor) quillEditor.setContents([]);

          // Reload stats and preview
          await loadEmailStats();
          await loadRecipientPreview();
        } else {
          showToast(res.message, 'error');
        }
      } catch (e) {
        console.error(' [EmailMkt] Campaign error:', e);
        showToast('Error sending emails: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function handleToggleAutoReminder(el) {
      const isActive = el.checked;
      showToast(isActive ? 'Enabling automation...' : 'Disabling automation...', 'info');

      try {
        const res = await callAPI('toggleAutoReminder', { isActive: isActive });
        if (res.success) {
          showToast(res.message, 'success');
        } else {
          el.checked = !isActive; // Revert
          showToast(res.message, 'error');
        }
      } catch (e) {
        el.checked = !isActive;
        showToast('Error: ' + e.message, 'error');
      }
    }

    // Reuse existing modal logic for Add Student but repurposed
    // We already have openModalAddStudent() but it's for Course Enrolment.
    // Let's create a specific one for Admin Direct Add
    function openModalAddStudent() {
      // Check if modal exists, if not create new or reuse
      // Current modalAddStudent requires 'addStudentCourseName' but for Admin we add to SYSTEM (all access?)
      // Actually, 'addStudentToSheet' in backend only adds to USERS sheet, not enrollment (allowedCourses is empty)
      // Admin can edit user later to add courses.

      const email = prompt("Enter Student Email:");
      const name = prompt("Enter Student Name:");

      if (email && name) {
        addStudentDirect(email, name);
      }
    }

    async function addStudentDirect(email, name) {
      showToast('Adding student...', 'info');
      try {
        const res = await callAPI('addStudentToSheet', { email, name });
        if (res.success) {
          showToast(res.message, 'success');
          loadAdminUsers(true);
        } else {
          showToast(res.message, 'error');
        }
      } catch (e) {
        showToast('Failed: ' + e.message, 'error');
      }
    }

    async function callAPI(action, data = {}) {
      try {
        const formData = new URLSearchParams();
        formData.append('action', action);

        // Flatten data object thnh form fields
        for (const key in data) {
          if (typeof data[key] === 'object' && data[key] !== null) {
            formData.append(key, JSON.stringify(data[key]));
          } else {
            formData.append(key, data[key]);
          }
        }

        const response = await fetch(API_URL, {
          method: 'POST',
          body: formData  //  FormData, khng phi JSON
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        return await response.json();

      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    const app = document.getElementById('app');
    let state = { view: 'login', course: null, lesson: null, user: null, courses: [] };
    let isTeacher = false;
    let lessonCount = 0;
    let editLessonCount = 0;

    let devToolsDetected = false;
    let warningCount = 0;
    let blurCount = 0;

    function showLoading() {
      const existing = document.getElementById('loader');
      if (existing) return;
      const loader = document.createElement('div');
      loader.id = 'loader';
      loader.textContent = ' ang ti...';
      document.body.appendChild(loader);
    }

    function hideLoading() {
      const loader = document.getElementById('loader');
      if (loader) loader.remove();
    }

    // ========== CACHE ==========
    const localCache = {
      data: {},
      get: function (key) {
        if (key === 'homeData') {
          console.log(' BYPASSING CACHE - Courses are always real-time');
          return null;
        }

        const item = this.data[key];
        if (!item) return null;
        if (Date.now() > item.expiry) {
          delete this.data[key];
          return null;
        }
        console.log(' Cache hit:', key);
        return item.value;
      },
      set: function (key, value, duration) {
        if (key === 'homeData') {
          console.log(' SKIP CACHE - Courses remain real-time');
          return;
        }

        this.data[key] = {
          value: value,
          expiry: Date.now() + (duration * 1000)
        };
      },
      clear: function () {
        this.data = {};
        console.log(' Cache cleared');
      }
    };

    // ========== SECURITY ==========
    function detectDevTools() {
      const threshold = 160;
      const widthThreshold = window.outerWidth - window.innerWidth > threshold;
      const heightThreshold = window.outerHeight - window.innerHeight > threshold;
      if (!(heightThreshold && widthThreshold) &&
        ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) ||
          widthThreshold || heightThreshold)) {
        if (!devToolsDetected) {
          devToolsDetected = true;
          handleDevToolsOpen('SIZE_CHANGE');
        }
      }
    }

    document.addEventListener('contextmenu', function (e) {
      if (state.view === 'lesson') {
        e.preventDefault();
        logWarning('RIGHT_CLICK', 'User attempted right-click on video page');
        showSecurityNotice(' Hnh ng ny  c ghi nhn!');
        return false;
      }
    });

    document.addEventListener('keydown', function (e) {
      if (state.view !== 'lesson') return;

      if (e.keyCode === 123) {
        e.preventDefault();
        handleDevToolsAttempt('F12_PRESSED');
        return false;
      }

      if ((e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.metaKey && e.altKey && e.keyCode === 73)) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_SHIFT_I');
        return false;
      }

      if ((e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.metaKey && e.altKey && e.keyCode === 74)) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_SHIFT_J');
        return false;
      }

      if ((e.ctrlKey && e.shiftKey && e.keyCode === 67) || (e.metaKey && e.altKey && e.keyCode === 67)) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_SHIFT_C');
        return false;
      }

      if (e.ctrlKey && e.keyCode === 85) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_U_VIEW_SOURCE');
        return false;
      }

      if (e.ctrlKey && e.keyCode === 83) {
        e.preventDefault();
        logWarning('SAVE_ATTEMPT', 'User attempted to save page');
        showSecurityNotice(' Khng th lu ni dung!');
        return false;
      }
    });

    function handleDevToolsAttempt(method) {
      warningCount++;
      logWarning('DEV_TOOLS_ATTEMPT', 'User attempted to open dev tools via ' + method);
      if (warningCount >= 3) {
        showSecurityNotice(' CNH BO: Hnh vi nghi ng  c ghi li! Admin s xem xt ti khon ca bn.');
        setTimeout(function () {
          if (confirm('Ti khon ca bn  b nh du do hnh vi nghi ng. Bn c mun quay v trang ch khng?')) {
            warningCount = 0;
            renderHome();
          }
        }, 2000);
      } else {
        showSecurityNotice(' Cnh bo ' + warningCount + '/3: Hnh ng ny vi phm chnh sch!');
      }
    }

    function handleDevToolsOpen(method) {
      logWarning('DEV_TOOLS_DETECTED', 'Dev tools opened via ' + method);
      showSecurityNotice(' Dev Tools  c pht hin! Hnh ng ca bn ang c ghi li.');

      const iframe = document.querySelector('#playerWrap iframe');
      if (iframe) {
        iframe.style.filter = 'blur(10px)';
      }
    }

    async function logWarning(type, description) {
      if (!state.user) return;
      const details = {
        description: description,
        course: state.course || '',
        lesson: state.lesson || '',
        browser: navigator.userAgent,
        timestamp: new Date().toISOString()
      };

      try {
        await callAPI('logSecurityWarning', {
          email: state.user.email,
          type: type,
          details: details
        });
        console.log('Warning logged');
      } catch (error) {
        console.error('Log warning failed:', error);
      }
    }

    function showSecurityNotice(message) {
      const existing = document.getElementById('securityNotice');
      if (existing) existing.remove();

      const notice = document.createElement('div');
      notice.id = 'securityNotice';
      notice.style.cssText =
        'position: fixed; top: 20px; left: 50%; transform: translateX(-50%);' +
        'background: rgba(220, 38, 38, 0.95); color: white; padding: 16px 32px;' +
        'border-radius: 8px; font-weight: 700; font-size: 16px; z-index: 10000;' +
        'box-shadow: 0 0 30px rgba(220, 38, 38, 0.6); animation: shake 0.5s; text-transform: uppercase; letter-spacing: 1px;';
      notice.textContent = message;

      document.body.appendChild(notice);

      setTimeout(function () {
        notice.style.transition = 'opacity 0.5s';
        notice.style.opacity = '0';
        setTimeout(function () { notice.remove(); }, 500);
      }, 5000);
    }

    // setInterval(detectDevTools, 1000);
    // window.addEventListener('resize', detectDevTools);

    window.addEventListener('blur', function () {
      if (state.view === 'lesson') {
        blurCount++;
        if (blurCount > 5) {
          logWarning('SUSPICIOUS_ACTIVITY', 'User switched tabs/windows ' + blurCount + ' times during video');
        }
      }
    });

    // ========== AUTH ==========
    function checkAuth() {
      const userData = localStorage.getItem('lms_user');
      if (userData) {
        try {
          state.user = JSON.parse(userData);
          return true;
        } catch (e) {
          localStorage.removeItem('lms_user');
        }
      }
      return false;
    }

    function logout() {
      localStorage.removeItem('lms_user');
      localCache.clear();
      state.user = null;
      state.view = 'login';
      isTeacher = false;
      renderLogin();
    }

    function setUrl(params) {
      const base = location.href.split('?')[0];
      const qs = new URLSearchParams(params).toString();
      history.pushState({}, '', qs ? base + '?' + qs : base);
    }

    function renderLogin() {
      app.innerHTML = '<div class="auth-container">' +
        '<h1 class="auth-title">NG NHP</h1>' +
        '<div id="loginMsg"></div>' +
        '<form id="loginForm" onsubmit="return false;">' +
        '<div class="form-group">' +
        '<label class="form-label">Email hoc S in thoi</label>' +
        '<input type="text" class="form-input" id="loginCredential" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Mt khu</label>' +
        '<input type="password" class="form-input" id="loginPassword" required>' +
        '</div>' +
        '<button type="submit" class="form-btn">ng nhp</button>' +
        '</form>' +
        '<div style="text-align:center;margin-top:12px;"><a onclick="forgotPassword()" style="color:#aaa;font-size:13px;cursor:pointer;">Qun mt khu?</a></div>' +
        '<div class="form-link">Cha c ti khon? <a onclick="renderRegister()">ng k ngay</a></div>' +
        '</div>';

      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    }

    // ========== FORGOT PASSWORD LOGIC ==========
    function forgotPassword() {
      // M modal
      document.getElementById('modalForgotPassword').classList.add('active');
      backToStep1();
      document.getElementById('forgotMsg').innerHTML = '';
      document.getElementById('resetEmail').value = '';
      document.getElementById('resetOTP').value = '';
      document.getElementById('resetNewPass').value = '';
    }

    function closeModalForgotPassword() {
      document.getElementById('modalForgotPassword').classList.remove('active');
    }

    function backToStep1() {
      document.getElementById('forgotStep1').style.display = 'block';
      document.getElementById('forgotStep2').style.display = 'none';
    }

    async function handleSendOTP() {
      const email = document.getElementById('resetEmail').value.trim();
      const msgDiv = document.getElementById('forgotMsg');

      if (!email) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui lng nhp email!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success">ang gi OTP...</div>';

      try {
        const result = await callAPI('sendOTP', { email: email });

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
          // Chuyn sang bc 2
          document.getElementById('forgotStep1').style.display = 'none';
          document.getElementById('forgotStep2').style.display = 'block';
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">Li kt ni: ' + error + '</div>';
      }
    }

    async function handleVerifyReset() {
      const email = document.getElementById('resetEmail').value.trim();
      const otp = document.getElementById('resetOTP').value.trim();
      const newPass = document.getElementById('resetNewPass').value.trim();
      const msgDiv = document.getElementById('forgotMsg');

      if (!otp || !newPass) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui lng nhp  thng tin!</div>';
        return;
      }

      if (newPass.length < 6) {
        msgDiv.innerHTML = '<div class="alert alert-error">Mt khu mi phi t 6 k t!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success">ang xc thc...</div>';

      try {
        const result = await callAPI('verifyOTPAndReset', {
          email: email,
          otp: otp,
          newPassword: newPass
        });

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success"> ' + result.message + '</div>';
          setTimeout(() => {
            closeModalForgotPassword();
            renderLogin();
          }, 2000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error"> ' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">Li kt ni: ' + error + '</div>';
      }
    }

    function renderRegister() {
      app.innerHTML = '<div class="auth-container">' +
        '<h1 class="auth-title">NG K</h1>' +
        '<div id="registerMsg"></div>' +
        '<form id="registerForm" onsubmit="return false;">' +
        '<div class="form-group">' +
        '<label class="form-label">H v tn</label>' +
        '<input type="text" class="form-input" id="registerName" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Email</label>' +
        '<input type="email" class="form-input" id="registerEmail" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">S in thoi</label>' +
        '<input type="tel" class="form-input" id="registerPhone" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Mt khu</label>' +
        '<input type="password" class="form-input" id="registerPassword" required minlength="6">' +
        '</div>' +
        '<button type="submit" class="form-btn">ng k</button>' +
        '</form>' +
        '<div class="form-link"> c ti khon? <a onclick="renderLogin()">ng nhp</a></div>' +
        '</div>';
      document.getElementById('registerForm').addEventListener('submit', handleRegister);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const credential = document.getElementById('loginCredential').value;
      const password = document.getElementById('loginPassword').value;
      const msgDiv = document.getElementById('loginMsg');

      msgDiv.innerHTML = '<div class="alert alert-success">ang ng nhp...</div>';

      try {
        const result = await callAPI('loginUser', { credential, password });

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
          localStorage.setItem('lms_user', JSON.stringify(result.user));
          state.user = result.user;
          setTimeout(function () {
            renderHome();
          }, 1000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">Li kt ni: ' + error + '</div>';
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const userData = {
        name: document.getElementById('registerName').value,
        email: document.getElementById('registerEmail').value,
        phone: document.getElementById('registerPhone').value,
        password: document.getElementById('registerPassword').value
      };
      const msgDiv = document.getElementById('registerMsg');

      msgDiv.innerHTML = '<div class="alert alert-success">ang x l...</div>';

      try {
        const result = await callAPI('registerUser', userData);

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
          setTimeout(function () {
            renderLogin();
          }, 2000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">Li: ' + error + '</div>';
      }
    }

    async function checkTeacherPermission() {
      if (!state.user) return;
      // Legacy function kept just in case, but syncUserProfile is preferred
      try {
        const result = await callAPI('checkIsTeacher', { email: state.user.email });
        isTeacher = result;
        if (isTeacher) {
          updateTopbarWithTeacherBtn();
          renderCourseGrid(state.courses || []);
        }
      } catch (error) {
        console.error('Check teacher error:', error);
      }
    }

    async function syncUserProfile() {
      if (!state.user) {
        console.log(' syncUserProfile: No user in state');
        return;
      }

      try {
        console.log(' syncUserProfile START - email:', state.user.email);
        const result = await callAPI('getUserProfile', { email: state.user.email });

        console.log(' syncUserProfile Response:', JSON.stringify(result));

        if (result.success) {
          console.log(' Profile synced successfully!');
          console.log('  - allowedCourses:', result.user.allowedCourses);
          console.log('  - isTeacher:', result.isTeacher);

          // Update Local State
          state.user.allowedCourses = result.user.allowedCourses;
          isTeacher = result.isTeacher;

          // Update Storage
          localStorage.setItem('lms_user', JSON.stringify(state.user));

          // UI Updates - Show teacher buttons if applicable
          if (isTeacher) {
            console.log(' User IS Teacher - Adding admin buttons...');
            updateTopbarWithTeacherBtn();
          } else {
            console.log(' User is NOT Teacher');
          }

          // Re-render grid with new permissions
          if (state.courses && state.courses.length > 0) {
            console.log(' Re-rendering course grid with updated permissions...');
            renderCourseGrid(state.courses);
          }
        } else {
          console.log(' syncUserProfile failed:', result.message);
        }
      } catch (error) {
        console.error(' Sync profile error:', error);
      }
    }

    function updateTopbarWithTeacherBtn() {
      console.log(' updateTopbarWithTeacherBtn called');

      const topbarRight = document.querySelector('.topbar-right');
      if (!topbarRight) {
        console.log(' topbar-right not found');
        return;
      }

      // Kim tra nu  c nt ri th khng thm na
      if (document.getElementById('btnQuickAdd')) {
        console.log(' Teacher buttons already exist');
        return;
      }

      console.log(' Adding teacher buttons...');

      const btnQuick = document.createElement('button');
      btnQuick.id = 'btnQuickAdd';
      btnQuick.className = 'btn btn-teacher';
      btnQuick.textContent = ' Thm Nhanh';
      btnQuick.onclick = openModalQuickAdd;
      btnQuick.style.marginRight = '12px';

      const btnDashboard = document.createElement('button');
      btnDashboard.id = 'btnAdminDashboard';
      btnDashboard.className = 'btn btn-teacher';
      btnDashboard.style.background = '#e50914'; // Red accent
      btnDashboard.style.marginRight = '12px';
      btnDashboard.innerHTML = ' Dashboard';
      btnDashboard.onclick = renderAdminDashboard;

      const btnManual = document.createElement('button');
      btnManual.id = 'btnAddCourse';
      btnManual.className = 'btn btn-teacher';
      btnManual.textContent = '+ Thm Th Cng';
      btnManual.onclick = openModalAddCourse;

      // Chn vo trc nt "ng xut"
      const logoutBtn = topbarRight.querySelector('.btn-logout');
      if (logoutBtn) {
        topbarRight.insertBefore(btnDashboard, logoutBtn);
        topbarRight.insertBefore(btnQuick, logoutBtn);
        topbarRight.insertBefore(btnManual, logoutBtn);
      } else {
        topbarRight.appendChild(btnDashboard);
        topbarRight.appendChild(btnQuick);
        topbarRight.appendChild(btnManual);
      }

      console.log(' Teacher buttons added!');
    }

    // ========== EDIT & DELETE ==========
    async function openEditCourse(courseName, event) {
      if (event) {
        event.stopPropagation();
      }

      showLoading();

      try {
        const result = await callAPI('getCourseForEdit', { courseName });
        hideLoading();

        if (result.success) {
          const data = result.data;

          document.getElementById('editOldCourseName').value = courseName;
          document.getElementById('editCourseName').value = data.courseName;
          document.getElementById('editCourseDesc').value = data.courseDesc || '';
          document.getElementById('editCourseThumbnail').value = data.thumbnail || '';

          const container = document.getElementById('editLessonsContainer');
          container.innerHTML = '';
          editLessonCount = 0;

          data.lessons.forEach(function (lesson) {
            editLessonCount++;
            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'lesson-item';
            lessonDiv.id = 'edit-lesson-' + editLessonCount;
            lessonDiv.innerHTML =
              '<div class="lesson-header">' +
              '<span class="lesson-title">Bi hc ' + editLessonCount + '</span>' +
              '<button type="button" class="btn btn-remove" onclick="removeEditLessonField(' + editLessonCount + ')">Xa</button>' +
              '</div>' +
              '<div class="form-group">' +
              '<label class="form-label">Tn bi hc *</label>' +
              '<input type="text" class="form-input edit-lesson-name" value="' + escapeHtml(lesson.name) + '" required>' +
              '</div>' +
              '<div class="form-group">' +
              '<label class="form-label">Video</label>' +
              '<input type="text" class="form-input edit-lesson-video" value="' + escapeHtml(lesson.videoUrl) + '" placeholder="Link Drive hoc URL">' +
              '<div class="file-input-group">' +
              '<button type="button" class="btn-pick-file" onclick="pickVideo(' + editLessonCount + ')"> Chn t Drive</button>' +
              '</div>' +
              '</div>' +
              '<div class="form-group">' +
              '<label class="form-label">Ti liu</label>' +
              '<input type="text" class="form-input edit-lesson-material" value="' + escapeHtml(lesson.materialUrl) + '" placeholder="Link Drive hoc URL">' +
              '<div class="file-input-group">' +
              '<button type="button" class="btn-pick-file" onclick="pickMaterial(' + editLessonCount + ')"> Chn t Drive</button>' +
              '</div>' +
              '</div>';
            container.appendChild(lessonDiv);
          });

          document.getElementById('modalEditCourse').classList.add('active');
          document.getElementById('modalEditMsg').innerHTML = '';
        } else {
          showToast('Li: ' + result.message, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Li: ' + error, 'error');
      }
    }

    function closeModalEditCourse() {
      document.getElementById('modalEditCourse').classList.remove('active');
    }

    function addEditLessonField() {
      editLessonCount++;
      const container = document.getElementById('editLessonsContainer');

      const lessonDiv = document.createElement('div');
      lessonDiv.className = 'lesson-item';
      lessonDiv.id = 'edit-lesson-' + editLessonCount;
      lessonDiv.innerHTML =
        '<div class="lesson-header">' +
        '<span class="lesson-title">Bi hc ' + editLessonCount + '</span>' +
        '<button type="button" class="btn btn-remove" onclick="removeEditLessonField(' + editLessonCount + ')">Xa</button>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Tn bi hc *</label>' +
        '<input type="text" class="form-input edit-lesson-name" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Video</label>' +
        '<input type="text" class="form-input edit-lesson-video" placeholder="Link Drive hoc URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickVideo(' + editLessonCount + ')"> Chn t Drive</button>' +
        '</div>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Ti liu</label>' +
        '<input type="text" class="form-input edit-lesson-material" placeholder="Link Drive hoc URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickMaterial(' + editLessonCount + ')"> Chn t Drive</button>' +
        '</div>' +
        '</div>';
      container.appendChild(lessonDiv);
    }

    function removeEditLessonField(id) {
      const elem = document.getElementById('edit-lesson-' + id);
      if (elem) elem.remove();
    }

    document.getElementById('formEditCourse').addEventListener('submit', async function (e) {
      e.preventDefault();

      const oldCourseName = document.getElementById('editOldCourseName').value;
      const courseName = document.getElementById('editCourseName').value.trim();
      const courseDesc = document.getElementById('editCourseDesc').value.trim();
      const thumbnail = document.getElementById('editCourseThumbnail').value.trim();

      const lessonItems = document.querySelectorAll('#editLessonsContainer .lesson-item');
      const lessons = [];

      lessonItems.forEach(function (item) {
        const name = item.querySelector('.edit-lesson-name').value.trim();
        const video = item.querySelector('.edit-lesson-video').value.trim();
        const material = item.querySelector('.edit-lesson-material').value.trim();

        if (name) {
          lessons.push({
            name: name,
            video: video,
            material: material
          });
        }
      });

      if (lessons.length === 0) {
        document.getElementById('modalEditMsg').innerHTML =
          '<div class="alert alert-error">Vui lng thm t nht 1 bi hc!</div>';
        return;
      }

      const courseData = {
        courseName: courseName,
        courseDesc: courseDesc,
        thumbnail: thumbnail,
        lessons: lessons
      };

      document.getElementById('modalEditMsg').innerHTML =
        '<div class="alert alert-success"> ang cp nht...</div>';

      try {
        const result = await callAPI('updateCourse', { oldCourseName, courseData });

        if (result.success) {
          document.getElementById('modalEditMsg').innerHTML =
            '<div class="alert alert-success"> ' + result.message + '</div>';

          localCache.clear();

          setTimeout(function () {
            closeModalEditCourse();
            renderHome();
          }, 1000);
        } else {
          document.getElementById('modalEditMsg').innerHTML =
            '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        document.getElementById('modalEditMsg').innerHTML =
          '<div class="alert alert-error">Li: ' + error + '</div>';
      }
    });

    async function refreshCourseConfirm(courseName, event) {
      if (event) {
        event.stopPropagation();
      }

      if (!confirm(' REFRESH KHA HC\n\nLm mi d liu t folder Drive ca kha hc "' + courseName + '"?\n\n S qut li ton b folder Drive\n Cp nht video/bi hc mi\n D liu c s c gi nguyn')) {
        return;
      }

      showLoading();

      try {
        const result = await callAPI('refreshCourse', { courseName });
        hideLoading();

        if (result.success) {
          localCache.clear();
          showToast(' ' + result.message + (result.details ? '  ' + result.details.lessonsCount + ' bi' : ''), 'success');
          renderHome();
        } else {
          showToast(' Li: ' + result.message, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast(' Li: ' + error, 'error');
      }
    }

    async function deleteCourseConfirm(courseName, event) {
      if (event) {
        event.stopPropagation();
      }

      if (!confirm(' XA KHA HC\n\nBn c chc chn mun xa "' + courseName + '"?\n\n Tt c bi hc s b xa\n Khng th hon tc')) {
        return;
      }

      showLoading();

      try {
        const result = await callAPI('deleteCourse', { courseName });
        hideLoading();

        if (result.success) {
          localCache.clear();
          showToast(' ' + result.message, 'success');
          renderHome();
        } else {
          showToast(' Li: ' + result.message, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast(' Li: ' + error, 'error');
      }
    }

    // ========== ADD COURSE ==========
    function openModalAddCourse() {
      document.getElementById('modalAddCourse').classList.add('active');
      document.getElementById('formAddCourse').reset();
      document.getElementById('lessonsContainer').innerHTML = '';
      document.getElementById('modalMsg').innerHTML = '';
      lessonCount = 0;
      addLessonField();
    }

    function closeModalAddCourse() {
      document.getElementById('modalAddCourse').classList.remove('active');
    }

    function addLessonField() {
      lessonCount++;
      const container = document.getElementById('lessonsContainer');

      const lessonDiv = document.createElement('div');
      lessonDiv.className = 'lesson-item';
      lessonDiv.id = 'lesson-' + lessonCount;
      lessonDiv.innerHTML =
        '<div class="lesson-header">' +
        '<span class="lesson-title">Bi hc ' + lessonCount + '</span>' +
        '<button type="button" class="btn btn-remove" onclick="removeLessonField(' + lessonCount + ')">Xa</button>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Tn bi hc *</label>' +
        '<input type="text" class="form-input lesson-name" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Video</label>' +
        '<input type="text" class="form-input lesson-video" placeholder="Link Drive hoc URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickVideo(' + lessonCount + ')"> Chn t Drive</button>' +
        '</div>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Ti liu</label>' +
        '<input type="text" class="form-input lesson-material" placeholder="Link Drive hoc URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickMaterial(' + lessonCount + ')"> Chn t Drive</button>' +
        '</div>' +
        '</div>';
      container.appendChild(lessonDiv);
    }

    function removeLessonField(id) {
      const elem = document.getElementById('lesson-' + id);
      if (elem) elem.remove();
    }

    function pickThumbnail() {
      showToast(' M Drive > Chut phi file > Get link > Copy & Paste vo y.', 'info');
    }

    function pickVideo(lessonId) {
      showToast(' M Drive > Chut phi Video > Get link > Copy & Paste vo y.', 'info');
    }

    function pickMaterial(lessonId) {
      showToast(' M Drive > Chut phi File > Get link > Copy & Paste vo y.', 'info');
    }

    document.getElementById('formAddCourse').addEventListener('submit', async function (e) {
      e.preventDefault();

      const courseName = document.getElementById('courseName').value.trim();
      const courseDesc = document.getElementById('courseDesc').value.trim();
      const thumbnail = document.getElementById('courseThumbnail').value.trim();

      const lessonItems = document.querySelectorAll('.lesson-item');
      const lessons = [];

      lessonItems.forEach(function (item) {
        const name = item.querySelector('.lesson-name').value.trim();
        const video = item.querySelector('.lesson-video').value.trim();
        const material = item.querySelector('.lesson-material').value.trim();

        if (name) {
          lessons.push({
            name: name,
            video: video,
            material: material
          });
        }
      });

      if (lessons.length === 0) {
        document.getElementById('modalMsg').innerHTML =
          '<div class="alert alert-error">Vui lng thm t nht 1 bi hc!</div>';
        return;
      }

      const courseData = {
        courseName: courseName,
        courseDesc: courseDesc,
        thumbnail: thumbnail,
        lessons: lessons
      };

      document.getElementById('modalMsg').innerHTML =
        '<div class="alert alert-success">ang to kha hc...</div>';

      try {
        const result = await callAPI('addCourse', courseData);

        if (result.success) {
          document.getElementById('modalMsg').innerHTML =
            '<div class="alert alert-success">' + result.message + '</div>';
          localCache.clear();
          setTimeout(function () {
            closeModalAddCourse();
            renderHome();
          }, 2000);
        } else {
          document.getElementById('modalMsg').innerHTML =
            '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        document.getElementById('modalMsg').innerHTML =
          '<div class="alert alert-error">Li: ' + error + '</div>';
      }
    });

    document.getElementById('modalAddCourse').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModalAddCourse();
      }
    });

    document.getElementById('modalEditCourse').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModalEditCourse();
      }
    });

    // ========== QUICK ADD ==========
    function openModalQuickAdd() {
      document.getElementById('modalQuickAdd').classList.add('active');
      document.getElementById('formQuickAdd').reset();
      document.getElementById('quickAddMsg').innerHTML = '';
    }

    function closeModalQuickAdd() {
      document.getElementById('modalQuickAdd').classList.remove('active');
    }

    document.getElementById('formQuickAdd').addEventListener('submit', async function (e) {
      e.preventDefault();

      const folderUrl = document.getElementById('quickFolderUrl').value.trim();
      const courseDesc = document.getElementById('quickCourseDesc').value.trim();
      const msgDiv = document.getElementById('quickAddMsg');

      if (!folderUrl) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui lng nhp link folder!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success"> ang qut folder...</div>';

      try {
        const result = await callAPI('quickAddCourseFromFolder', { folderUrl, courseDesc });

        if (result.success) {
          msgDiv.innerHTML =
            '<div class="alert alert-success">' +
            '<strong> ' + result.message + '</strong><br>' +
            (result.details ?
              '<div style="margin-top:8px;font-size:13px;">' +
              ' Kha hc: ' + result.details.courseName + '<br>' +
              ' S bi hc: ' + result.details.lessonsCount +
              '</div>' : '') +
            '</div>';

          localCache.clear();
          localStorage.removeItem(HOME_CACHE_KEY);

          setTimeout(function () {
            closeModalQuickAdd();
            renderHome(true);
          }, 3000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error"> ' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error"> Li: ' + error + '</div>';
      }
    });

    document.getElementById('modalQuickAdd').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModalQuickAdd();
      }
    });

    // ========== ADD STUDENT ==========
    function openModalAddStudent(courseName, courseCode, event) {
      if (event) event.stopPropagation();

      // Kim tra nu kha hc cha c m
      if (!courseCode || courseCode === '' || courseCode === 'undefined') {
        showToast(' Kha hc "' + courseName + '" cha c m! Vui lng thm m  Sheet Courses.', 'warning');
        return;
      }

      document.getElementById('modalAddStudent').classList.add('active');
      document.getElementById('addStudentCourseName').value = courseCode;
      document.getElementById('lblCourseName').textContent = courseName + ' (M: ' + courseCode + ')';
      document.getElementById('listEmails').value = '';
      document.getElementById('addStudentMsg').innerHTML = '';
    }

    function closeModalAddStudent() {
      document.getElementById('modalAddStudent').classList.remove('active');
    }

    document.getElementById('formAddStudent').addEventListener('submit', async function (e) {
      e.preventDefault();
      const courseCode = document.getElementById('addStudentCourseName').value; // y l courseCode
      const emails = document.getElementById('listEmails').value;
      const msgDiv = document.getElementById('addStudentMsg');

      if (!emails.trim()) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui lng nhp email!</div>';
        return;
      }

      if (!courseCode) {
        msgDiv.innerHTML = '<div class="alert alert-error">Kha hc cha c m! Vui lng thm m trong Sheet Courses ct H.</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success"> ang x l...</div>';

      try {
        // Gi courseCode thay v courseName
        const result = await callAPI('addStudentsToCourse', { courseCode, emails });
        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success"> ' + result.message + '</div>';
          setTimeout(() => closeModalAddStudent(), 2000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">Li: ' + error + '</div>';
      }
    });

    document.getElementById('modalAddStudent').addEventListener('click', function (e) {
      if (e.target === this) closeModalAddStudent();
    });

    // ========== RENDER HOME (OPTIMIZED WITH CACHE) ==========
    const HOME_CACHE_KEY = 'lms_home_cache';

    async function renderHome(forceRefresh = false) {
      state.view = 'home';
      setUrl({});

      // Clean up old elements
      const adminSidebar = document.getElementById('adminSidebar');
      if (adminSidebar) adminSidebar.remove();

      // 1. TEACHER LAYOUT -> REDIRECT TO UNIFIED DASHBOARD
      if (isTeacher) {
        renderAdminDashboard('courses');
        return;
      }

      // 2. STUDENT LAYOUT (TOPBAR - GI NGUYN HOC TI U SAU)
      else {
        // STUDENT LAYOUT - NEW DESIGN
        const firstName = state.user.name ? state.user.name.split(' ')[0] : 'Bn';

        app.innerHTML = `
          <!-- TOPBAR -->
          <div class="topbar">
             <div class="topbar-left">
                <div class="logo">ACADEMY</div>
             </div>
             
             <div class="search-wrapper">
                <div class="search-icon"><i data-lucide="search"></i></div>
                <input type="text" class="search-input" placeholder="Tm kim bi hc..." oninput="handleSearch(this.value)">
                <div class="search-dropdown" id="searchDropdown"></div>
             </div>

             <div class="topbar-right">
                <button class="btn-circle" onclick="renderHome(true)" title="Lm mi"><i data-lucide="rotate-cw"></i></button>
                <div class="user-info" onclick="openPersonalProfile()" style="cursor:pointer">
                   <div style="width:32px;height:32px;border-radius:50%;background:var(--bg-800);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text-primary)">
                      <i data-lucide="user"></i>
                   </div>
                   <span style="font-size:13px; font-weight:600; margin-left:8px; display:none; @media(min-width:768px){display:inline}">${escapeHtml(state.user.name)}</span>
                </div>
                <!-- <button class="btn btn-logout" onclick="logout()"><i data-lucide="log-out"></i></button> -->
             </div>
          </div>
          
          <!-- HERO SECTION -->
          <div class="hero-section">
             <div class="hero-welcome">
                <div class="hero-title">Xin cho, ${escapeHtml(firstName)} </div>
                <div class="hero-subtitle">Sn sng bt ph hm nay cha?</div>
             </div>
             
             <!-- QUICK STATS -->
             <div class="quick-stats">
                <div class="stat-box">
                   <div class="stat-icon"><i data-lucide="book-open"></i></div>
                   <div class="stat-info">
                      <h4 id="statTotalCourses">--</h4>
                      <p>Kha hc</p>
                   </div>
                </div>
                <div class="stat-box">
                   <div class="stat-icon"><i data-lucide="check-circle-2"></i></div>
                   <div class="stat-info">
                      <h4 id="statCompleted">--</h4>
                      <p> hon thnh</p>
                   </div>
                </div>
                <div class="stat-box">
                   <div class="stat-icon"><i data-lucide="zap"></i></div>
                   <div class="stat-info">
                      <h4 id="statActive">--</h4>
                      <p>ang hc</p>
                   </div>
                </div>
                <div class="stat-box" style="border-color:var(--brand-red); background:rgba(220,38,38,0.05)">
                   <div class="stat-icon" style="background:var(--brand-red); color:white"><i data-lucide="trophy"></i></div>
                   <div class="stat-info">
                      <h4 id="statPoints">PRO</h4>
                      <p>Thnh vin</p>
                   </div>
                </div>
             </div>
          </div>

          <!-- CONTINUE LEARNING (FEATURED) -->
          <div id="featuredCourseArea"></div>

          <!-- ALL COURSES -->
          <div class="section-header">
             <div class="section-title">
                <i data-lucide="grid" style="color:var(--brand-red)"></i>
                Tt c kha hc
             </div>
          </div>
          
          <div id="homeGrid" class="grid" style="padding: 0 4% 60px; max-width:1400px; margin:0 auto"></div>

          <!-- MODAL PROFILE -->
          <div class="profile-modal-overlay" id="modalUserProfile" onclick="if(event.target===this) closeUserProfile()">
             <div class="profile-modal"><div id="userProfileContent"></div></div>
          </div>
        `;
      }

      console.log(' renderHome START (Optimized with Cache)...');

      // Check localStorage cache first (unless forceRefresh)
      if (!forceRefresh) {
        const cached = localStorage.getItem(HOME_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() < parsed.expiry) {
              console.log(' Home from localStorage cache!');
              const indicator = document.getElementById('homeCacheIndicator');
              if (indicator) indicator.textContent = ' Instant';
              processHomeData(parsed.data, false);
              return;
            }
          } catch (e) { /* cache invalid */ }
        }
      }

      try {
        const result = await callAPI('getHomeDataWithProfile', { email: state.user.email });

        if (!result.success) throw new Error(result.message || 'API failed');

        // Save to cache
        localStorage.setItem(HOME_CACHE_KEY, JSON.stringify({
          data: result,
          expiry: Date.now() + DASHBOARD_CACHE_DURATION
        }));

        const indicator = document.getElementById('homeCacheIndicator');
        if (indicator) indicator.textContent = ' Fresh';

        processHomeData(result, true);

      } catch (error) {
        console.error(' renderHome ERROR:', error);
        hideLoading();
        app.innerHTML = '<div style="color:#ff4444;text-align:center;margin-top:100px;font-weight:700;">Li: ' + error + '</div>';
      }
    }

    // Process home data (reusable for cache and fresh)
    function processHomeData(result, isFresh) {
      // Cp nht profile & quyn
      if (result.profile) {
        const prevTeacher = isTeacher;
        if (result.profile.user) {
          state.user.allowedCourses = result.profile.user.allowedCourses || '';
          localStorage.setItem('lms_user', JSON.stringify(state.user));
        }
        isTeacher = result.profile.isTeacher;
        console.log(' Profile loaded - isTeacher:', isTeacher);

        // Nu trng thi Teacher thay i (Student -> Teacher), render li  hin Sidebar
        if (!prevTeacher && isTeacher) {
          console.log(' Detected Teacher permission -> Switching layout...');
          // Clear cache to force re-render with correct layout
          localStorage.removeItem(HOME_CACHE_KEY);
          renderHome();
          return;
        }
      }

      const courses = result.courses || [];
      state.courses = courses;

      // UPDATE STATS & HERO (STUDENT ONLY)
      if (!isTeacher) {
        const total = courses.length;
        const completed = courses.filter(c => c.progress === 100).length;
        const active = courses.filter(c => c.progress > 0 && c.progress < 100).length;

        const elTotal = document.getElementById('statTotalCourses');
        if (elTotal) elTotal.innerText = total < 10 ? '0' + total : total;

        const elCompleted = document.getElementById('statCompleted');
        if (elCompleted) elCompleted.innerText = completed < 10 ? '0' + completed : completed;

        const elActive = document.getElementById('statActive');
        if (elActive) elActive.innerText = active < 10 ? '0' + active : active;

        // Render Featured Course (First active or first available)
        const featured = courses.find(c => c.progress > 0 && c.progress < 100) || (courses.length > 0 ? courses[0] : null);
        const featuredArea = document.getElementById('featuredCourseArea');

        if (featured && featuredArea) {
          const progress = featured.progress || 0;
          featuredArea.innerHTML = `
                <div class="featured-card" onclick="openCourse('${featured.courseName}')" style="cursor:pointer">
                   <img src="${convertDriveUrl(featured.thumbnailUrl)}" class="featured-thumb" 
                        onerror="if(this.src.includes('thumbnail?')) { this.src = 'https://drive.google.com/uc?export=view&id=' + '${convertDriveUrl(featured.thumbnailUrl)}'.split('id=')[1].split('&')[0]; } else { this.src='https://via.placeholder.com/800x450?text=Course'; }">
                   <div class="featured-content">
                      <div class="featured-badge">${progress > 0 ? 'ANG HC' : 'KHA HC MI'}</div>
                      <h3 style="font-size:28px; font-weight:700; margin-bottom:12px; line-height:1.3; color:var(--text-primary)">
                        ${escapeHtml(featured.courseName)}
                      </h3>
                      <p style="color:var(--text-muted); margin-bottom:24px; line-height:1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${progress > 0 ? 'Tip tc hnh trnh chinh phc kin thc ngay by gi.' : 'Khm ph ni dung mi v nng cao k nng ca bn.'}
                      </p>
                      
                      <div style="margin-bottom:24px; width:100%; max-width:400px">
                         <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; font-weight:600">
                            <span style="color:var(--text-secondary)">Tin </span>
                            <span style="color:var(--brand-red)">${progress}%</span>
                         </div>
                         <div class="progress-bar" style="height:6px; background:var(--bg-700)">
                            <div class="progress-fill" style="width:${progress}%; height:100%; border-radius:10px; background:var(--brand-red)"></div>
                         </div>
                      </div>
                      
                      <button class="btn btn-red" style="width:fit-content; padding:12px 32px; border-radius:30px; font-weight:700">
                         ${progress > 0 ? 'TIP TC HC' : 'BT U NGAY'} 
                         <i data-lucide="arrow-right" style="margin-left:8px; width:16px; vertical-align:middle; display:inline-block"></i>
                      </button>
                   </div>
                </div>
             `;
        }
      }

      if (courses.length === 0) {
        const grid = document.getElementById('homeGrid');
        if (grid) {
          grid.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text-muted);grid-column:1/-1;">' +
            '<div style="font-size:48px;margin-bottom:16px;opacity:0.5"></div>' +
            '<div style="font-size:18px;font-weight:600;">Cha c kha hc no</div>' +
            '</div>';
        }
      } else {
        renderCourseGrid(courses);
      }

      hideLoading();
      if (window.lucide) lucide.createIcons();
    }

    function renderCourseGrid(courses) {
      const grid = document.getElementById('homeGrid');
      if (!grid) return;

      // Helper: Normalize string for comparison
      function normalizeStr(str) {
        return String(str)
          .trim()
          .normalize('NFC')
          .replace(/\s+/g, ' ')
          .toLowerCase();
      }

      // Ly danh sch m kha hc c php (K1, K2...)
      let allowedCodes = [];
      if (state.user && state.user.allowedCourses) {
        allowedCodes = state.user.allowedCourses.split(',').map(s => s.trim().toUpperCase());
      }

      //  DEBUG: Log permission info
      console.log(' DEBUG - User allowed codes:', allowedCodes);
      console.log(' DEBUG - Is Teacher:', isTeacher);
      console.log(' DEBUG - All courses:', courses.map(c => c.courseName + ' (' + (c.courseCode || 'N/A') + ')'));

      const fragment = document.createDocumentFragment();
      courses.forEach(function (c) {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.course = c.courseName;

        // Kim tra quyn bng m kha hc (K1, K2...)
        const courseCode = (c.courseCode || '').toUpperCase();
        const isAllowed = isTeacher || allowedCodes.includes(courseCode);

        //  DEBUG
        console.log(' Course: ' + c.courseName + ' Code: ' + courseCode + ' | Allowed: ' + isAllowed);

        let overlay = '';
        if (!isAllowed) {
          card.classList.add('locked');
          overlay = '<div class="locked-overlay"><div class="locked-icon"></div><div>CHA M KHA</div></div>';
        }

        const thumb = c.thumbnailUrl
          ? '<img class="thumb" src="' + toImgUrl(c.thumbnailUrl) + '" loading="lazy" />'
          : '<div class="thumb"></div>';

        const actions = isTeacher ?
          '<div class="course-actions">' +
          '<div class="btn-icon btn-report" onclick="openCourseReport(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', \'' + escapeHtml(courseCode).replace(/'/g, "\\'") + '\', event)" title="Bo co"><i data-lucide="bar-chart-2"></i></div>' +
          '<div class="btn-icon btn-add-student" onclick="openModalAddStudent(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', \'' + escapeHtml(courseCode).replace(/'/g, "\\'") + '\', event)" title="Thm hc vin"><i data-lucide="user-plus"></i></div>' +
          '<div class="btn-icon btn-refresh" onclick="refreshCourseConfirm(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', event)" title="Refresh kha hc"><i data-lucide="refresh-cw"></i></div>' +
          '<div class="btn-icon btn-edit" onclick="openEditCourse(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', event)" title="Chnh sa"><i data-lucide="pencil"></i></div>' +
          '<div class="btn-icon btn-delete" onclick="deleteCourseConfirm(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', event)" title="Xa"><i data-lucide="trash-2"></i></div>' +
          '</div>' : '';

        card.innerHTML = overlay + thumb + actions +
          '<h3>' + escapeHtml(c.courseName) + '</h3>' +
          '<div class="muted">' + escapeHtml(c.courseDesc || 'Khm ph ni dung kha hc') + '</div>';

        card.addEventListener('click', function (e) {
          if (!e.target.closest('.course-actions')) {
            if (isAllowed) {
              openCourse(c.courseName);
            } else {
              showToast(' Bn cha ng k kha hc ny!', 'warning');
            }
          }
        });

        fragment.appendChild(card);
      });

      grid.innerHTML = '';
      grid.appendChild(fragment);

      // Init icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function openCourse(courseName) {
      showLoading();
      state.view = 'course';
      state.course = courseName;
      state.lesson = null;
      setUrl({ course: courseName });

      app.innerHTML = '<div class="topbar">' +
        '<div class="topbar-left">' +
        '<button class="btn" id="backBtn"> Trang ch</button>' +
        '<h2>' + escapeHtml(courseName) + '</h2>' +
        '</div>' +
        '<div class="topbar-right">' +
        '<div class="user-info" onclick="openPersonalProfile()" style="cursor:pointer" title="Xem h s c nhn"> ' + escapeHtml(state.user.name) + '</div>' +
        '<button class="btn btn-logout" onclick="logout()">ng xut</button>' +
        '</div>' +
        '</div>' +
        '<div id="courseDesc" class="muted"></div>' +
        '<h3>BI HC</h3>' +
        '<div id="lessonGrid" class="lesson-grid"></div>';

      document.getElementById('backBtn').onclick = function () {
        state = { view: 'home', user: state.user };
        setUrl({});
        renderHome();
      };

      const cacheKey = 'course_' + courseName;
      const cached = localCache.get(cacheKey);
      if (cached) {
        renderCourseContent(cached);
        hideLoading();
        if (isTeacher) updateTopbarWithTeacherBtn();
        return;
      }

      try {
        const data = await callAPI('getCourseData', { courseName });
        localCache.set(cacheKey, data, 180);
        renderCourseContent(data);
        hideLoading();
      } catch (error) {
        hideLoading();
        showToast('Li: ' + error, 'error');
      }

      if (isTeacher) updateTopbarWithTeacherBtn();
    }

    function renderCourseContent(data) {
      document.getElementById('courseDesc').textContent = data.courseDesc || 'Chn bi hc  bt u';
      const grid = document.getElementById('lessonGrid');
      if (!grid) return;

      const fragment = document.createDocumentFragment();
      data.lessons.forEach(function (ls) {
        const lessonDiv = document.createElement('div');
        lessonDiv.className = 'lesson';
        lessonDiv.dataset.idx = ls.index;
        lessonDiv.innerHTML =
          '<div class="muted">BI ' + ls.index + '</div>' +
          '<div>' + escapeHtml(ls.lessonName) + '</div>';

        lessonDiv.addEventListener('click', function () {
          openLesson(data.courseName, ls.index);
        });

        fragment.appendChild(lessonDiv);
      });

      grid.innerHTML = '';
      grid.appendChild(fragment);
    }


    // ========== LESSON VIEW (FOCUS MODE) ==========

    function switchLessonTab(tabId, btn) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      document.getElementById('tab-' + tabId).classList.add('active');
      btn.classList.add('active');
    }

    async function openLesson(courseName, lessonIndex) {
      // 1. Setup UI Shell (Focus Mode)
      state.view = 'lesson';
      state.course = courseName;
      state.lesson = lessonIndex;
      setUrl({ course: courseName, lesson: lessonIndex });

      app.innerHTML = `
        <!-- FOCUS HEADER -->
        <div class="focus-header">
           <div class="focus-title">
              <div class="btn-circle" id="backCourseBtn" title="Back to Course">
                 <i data-lucide="chevron-left"></i>
              </div>
              <span>${escapeHtml(courseName)}</span>
           </div>
           
           <div class="user-info" style="display:flex;align-items:center;gap:12px">
              <div style="text-align:right">
                 <div style="font-size:12px;color:var(--text-muted)">Tin </div>
                 <div style="font-weight:700;color:var(--brand-red)" id="headerProgress">0%</div>
              </div>
              <div class="btn-circle" onclick="toggleTheme()" title="Settings">
                 <i data-lucide="settings"></i>
              </div>
              <div class="btn-circle" onclick="renderHome()" title="Home">
                 <i data-lucide="x"></i>
              </div>
           </div>
        </div>

        <!-- MAIN LAYOUT -->
        <div class="lesson-layout">
           <!-- LEFT: VIDEO & TABS -->
           <div class="lesson-main">
              <!-- Video Player -->
              <div id="playerWrap" class="video-container"></div>
              
              <!-- Bento Tabs Section -->
              <div class="bento-tabs">
                 <div class="tab-header">
                    <button class="tab-btn active" onclick="switchLessonTab('overview', this)">Tng quan</button>
                    <button class="tab-btn" onclick="switchLessonTab('qa', this)">Hi p</button>
                    <button class="tab-btn" onclick="switchLessonTab('materials', this)">Ti liu</button>
                    <button class="tab-btn" onclick="switchLessonTab('notes', this)">Ghi ch</button>
                 </div>
                 
                 <!-- Tab Contents -->
                 <div id="tab-overview" class="tab-content active">
                    <h2 id="lessonTitle" style="margin-bottom:16px;font-size:24px">ang ti...</h2>
                    <p id="lessonDesc" style="color:var(--text-muted);font-size:14px;line-height:1.6">
                       M t bi hc ang c cp nht.
                    </p>
                 </div>
                 
                 <div id="tab-qa" class="tab-content">
                    <div class="muted">Tnh nng hi p ang pht trin...</div>
                 </div>
                 
                 <div id="tab-materials" class="tab-content">
                    <div id="materialsArea">
                       <div class="muted">ang ti ti liu...</div>
                    </div>
                 </div>
                 
                 <div id="tab-notes" class="tab-content">
                    <div class="muted">Tnh nng ghi ch ang pht trin...</div>
                 </div>
              </div>
           </div>
           
           <!-- RIGHT: PLAYLIST SIDEBAR -->
           <div class="lesson-sidebar">
              <div class="playlist-header">
                 <h3 style="font-size:16px">Ni dung kha hc</h3>
                 <div style="font-size:12px;color:var(--text-muted)" id="courseTotalLessons">0 bi hc</div>
              </div>
              
              <div class="playlist-content" id="sidebarLessonList">
                 <!-- Playlist items injected here -->
              </div>
              
              <div class="playlist-footer" id="completeBtnContainer">
                 <!-- Next button injected here -->
              </div>
           </div>
        </div>
      `;

      // Initialize Icons
      if (window.lucide) lucide.createIcons();

      document.getElementById('backCourseBtn').onclick = function () { openCourse(courseName); };


      const cacheKey = 'course_' + courseName;
      let courseData = localCache.get(cacheKey);

      // --- LOGIC MI: OPTIMISTIC UI ---

      // Bc 1: Render ni dung bi hc ngay nu c Cache (Video, Material, List bi)
      if (courseData) {
        renderLessonShell(courseData, lessonIndex);
      } else {
        showLoading(); // Ch hin loading nu cha c data kha hc
      }

      // Bc 2: Fetch Data mi (nu cn) & Fetch Progress (Chy ngm)
      try {
        if (!courseData) {
          courseData = await callAPI('getCourseData', { courseName });
          localCache.set(cacheKey, courseData, 180);
          hideLoading();
          renderLessonShell(courseData, lessonIndex);
        }

        // === IMPORTANT: Store courseData globally for completion tracking ===
        if (!window._currentCourseData) window._currentCourseData = {};
        window._currentCourseData[courseData.courseCode] = courseData;

        // Bc 3: Fetch Progress NGM (Khng chn UI)
        fetchAndRenderProgress(courseData.courseCode, lessonIndex, courseData);

      } catch (error) {
        hideLoading();
        showToast('Li: ' + error, 'error');
      }

      if (isTeacher) updateTopbarWithTeacherBtn();
    }

    // Hm tch bit: Ch fetch v update progress tick xanh
    async function fetchAndRenderProgress(courseCode, lessonIndex, courseData) {
      if (!courseCode) return;
      try {
        const pData = await callAPI('getProgress', { email: state.user.email, courseCode: courseCode });
        if (pData.success) {
          // Cache progress for optimistic updates
          if (!window._cachedProgressList) window._cachedProgressList = {};
          window._cachedProgressList[courseCode] = pData.progress || [];

          updateLessonProgress(pData.progress, lessonIndex, courseData);
        }
      } catch (e) { console.warn('Fetch progress background error', e); }
    }

    // Hm tch bit: Update UI sau khi c progress
    // Hm tch bit: Update UI sau khi c progress
    function updateLessonProgress(progressList, currentLessonIdx, courseData) {
      if (!courseData) return;

      // 1. Calculate & Update Header Progress
      let completedParams = 0;
      if (progressList) {
        completedParams = progressList.filter(p => p.completedAt && String(p.completedAt).trim() !== '').length;
      }
      const total = courseData.lessons.length;
      const percent = total > 0 ? Math.round((completedParams / total) * 100) : 0;

      const headerProgress = document.getElementById('headerProgress');
      if (headerProgress) headerProgress.innerText = percent + '%';

      // 2. Find Next Lesson
      const nextLesson = courseData.lessons.find(l => l.index === currentLessonIdx + 1);

      // 3. Update Sidebar Footer (Complete + Next Buttons)
      const footerContainer = document.getElementById('completeBtnContainer');
      if (footerContainer) {
        // Check if current lesson is completed
        const isCurrentCompleted = progressList && progressList.some(p =>
          p.lessonIndex === currentLessonIdx && p.completedAt && String(p.completedAt).trim() !== ''
        );

        // Check if ALL lessons are completed
        const totalLessons = courseData.lessons.length;
        const completedCount = progressList ? progressList.filter(p =>
          p.completedAt && String(p.completedAt).trim() !== ''
        ).length : 0;
        const allLessonsCompleted = completedCount === totalLessons;

        const nextLesson = courseData.lessons.find(l => l.index === currentLessonIdx + 1);

        let html = '';

        // 1. Complete Button (if not completed yet)
        if (!isCurrentCompleted) {
          html += `
            <button class="btn btn-red" style="width:100%; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center" 
               onclick="markCurrentLessonComplete('${courseData.courseCode}', ${currentLessonIdx}, '${courseData.courseName}')">
               <span>Hon thnh bi hc</span>
               <i data-lucide="check-circle-2"></i>
            </button>
          `;
        } else {
          html += `
            <button class="btn" style="width:100%; margin-bottom:12px; border-color:var(--success); color:var(--success); background:rgba(34,197,94,0.1); cursor:default">
               <i data-lucide="check-circle-2" style="margin-right:8px"></i>
                hon thnh
            </button>
          `;
        }

        // 2. Next Button (if has next lesson) OR Congratulations (if ALL completed)
        if (nextLesson) {
          html += `
            <button class="btn" style="width:100%; background:var(--bg-800); border-color:var(--border); display:flex; justify-content:space-between; align-items:center" 
               onclick="openLesson('${courseData.courseName}', ${nextLesson.index})">
               <span>Bi tip theo</span>
               <i data-lucide="arrow-right"></i>
            </button>
          `;
        } else if (allLessonsCompleted) {
          // Last lesson AND ALL lessons completed  Show congratulations
          html += `
            <button class="btn" style="width:100%; border-color:var(--success); color:var(--success); background:rgba(34,197,94,0.05); cursor:default">
               <i data-lucide="party-popper" style="margin-right:8px"></i>
               Chc mng!  hon thnh kha hc
            </button>
          `;
        }

        footerContainer.innerHTML = html;
        if (window.lucide) lucide.createIcons();
      }

      // 4. Update Sidebar List (Re-render to show ticks)
      const sidebarList = document.getElementById('sidebarLessonList');
      if (sidebarList) {
        renderSidebarList(courseData, currentLessonIdx, progressList);
      }
    }

    async function markCurrentLessonComplete(courseCode, lessonIndex, courseName) {
      try {
        // Get courseData from global storage
        let courseData = null;
        if (window._currentCourseData && window._currentCourseData[courseCode]) {
          courseData = window._currentCourseData[courseCode];
        } else {
          // Fallback: try to find in state.courses
          courseData = state.courses ? state.courses.find(c => c.courseCode === courseCode) : null;
        }

        if (!courseData || !courseData.lessons || !Array.isArray(courseData.lessons)) {
          console.error('Invalid courseData:', courseData);
          console.error('Available course data:', window._currentCourseData);
          showToast('Li: D liu kha hc khng hp l', 'error');
          return;
        }

        // === OPTIMISTIC UPDATE ===
        // 1. Update UI IMMEDIATELY (khng ch API)

        // Create fake progress entry for current lesson
        const now = new Date().toLocaleString('vi-VN');
        const optimisticProgress = {
          lessonIndex: lessonIndex,
          completedAt: now,
          videoTime: 0
        };

        // Get current progressList or create empty array
        let currentProgressList = [];
        if (window._cachedProgressList && window._cachedProgressList[courseCode]) {
          currentProgressList = [...window._cachedProgressList[courseCode]];
        }

        // Add or update the completed lesson
        const existingIndex = currentProgressList.findIndex(p => p.lessonIndex === lessonIndex);
        if (existingIndex >= 0) {
          currentProgressList[existingIndex] = optimisticProgress;
        } else {
          currentProgressList.push(optimisticProgress);
        }

        // Cache for next use
        if (!window._cachedProgressList) window._cachedProgressList = {};
        window._cachedProgressList[courseCode] = currentProgressList;

        // Update UI immediately with optimistic data
        updateLessonProgress(currentProgressList, lessonIndex, courseData);

        showToast('  hon thnh bi hc!', 'success');

        const totalLessons = courseData.lessons.length;

        // === BACKGROUND SAVE + VERIFY COMPLETION ===
        saveLessonProgress(courseCode, lessonIndex, 0, true)
          .then(async () => {
            console.log(' Saved to sheet successfully');

            // IMPORTANT: Fetch FRESH progress from server to verify completion
            const freshData = await callAPI('getProgress', {
              email: state.user.email,
              courseCode: courseCode
            });

            if (freshData.success && freshData.progress) {
              // Update cache with fresh data
              window._cachedProgressList[courseCode] = freshData.progress;

              // Count ACTUAL completed lessons from server
              const actualCompletedCount = freshData.progress.filter(p =>
                p.completedAt &&
                String(p.completedAt).trim() !== '' &&
                String(p.completedAt).trim() !== '0'
              ).length;

              console.log(`Completion check (from server): ${actualCompletedCount}/${totalLessons}`);

              // Check if ALL lessons completed
              if (actualCompletedCount >= totalLessons) {
                console.log(' Course completed! Saving course completion...');

                const result = await callAPI('markCourseCompleted', {
                  email: state.user.email,
                  courseCode: courseCode,
                  courseName: courseName
                });

                if (result.success) {
                  showToast(' Chc mng! Bn  hon thnh ton b kha hc!', 'success', 5000);
                  // Update UI to show congratulations
                  updateLessonProgress(freshData.progress, lessonIndex, courseData);
                } else {
                  console.error('Failed to mark course completed:', result.message);
                }
              }
            }
          })
          .catch(err => {
            console.error(' Failed to save:', err);
            showToast('Cnh bo: Lu tin  tht bi. Vui lng kim tra kt ni.', 'warning', 3000);
          });

      } catch (e) {
        console.error('Error in markCurrentLessonComplete:', e);
        showToast('Li: ' + e.message, 'error');
      }
    }

    // Hm Render chnh (Ch render cu trc, update content vo Bento Tabs)
    function renderLessonShell(data, lessonIndex) {
      const lesson = data.lessons.find(function (x) { return x.index === lessonIndex; });
      const playerWrap = document.getElementById('playerWrap');
      const completeBtnContainer = document.getElementById('completeBtnContainer');
      const sidebarList = document.getElementById('sidebarLessonList');
      const courseTotalLessons = document.getElementById('courseTotalLessons');

      if (courseTotalLessons) courseTotalLessons.innerText = data.lessons.length + ' bi hc';

      warningCount = 0; devToolsDetected = false; blurCount = 0;

      // 1. Render Video (Stable Mode)
      if (lesson && lesson.videoEmbedUrl) {
        let secureUrl = lesson.videoEmbedUrl;
        // Optimize Google Drive links
        if (secureUrl.includes('drive.google.com')) {
          secureUrl = secureUrl.replace(/\/view.*$/, '/preview').replace(/\/edit.*$/, '/preview');
        }
        const separator = secureUrl.includes('?') ? '&' : '?';
        secureUrl += separator + 'rm=minimal';

        const watermarkText = state.user.email;

        playerWrap.innerHTML = `
          <div class="video-controls-blocker"></div>
          <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
               font-size:32px; color:rgba(255,255,255,0.08); font-weight:900; pointer-events:none; 
               z-index:5; user-select:none; white-space:nowrap; text-transform:uppercase; letter-spacing:4px;">
            ${escapeHtml(watermarkText)}
          </div>
          <iframe src="${secureUrl}" frameborder="0" allow="autoplay; encrypted-media" 
            sandbox="allow-scripts allow-same-origin allow-presentation" allowfullscreen 
            style="width:100%; height:100%; position:absolute; top:0; left:0; z-index:1;"></iframe>
        `;

        if (window.lucide) lucide.createIcons();

        // Anti Right Click
        playerWrap.oncontextmenu = function (e) { e.preventDefault(); return false; };

        // Save LastViewed
        saveLessonProgress(data.courseCode, lessonIndex, 0, false);
      } else {
        playerWrap.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted)">Khng c video</div>';
      }

      // 2. Setup Bento Tab Contents (Overview)
      const titleEl = document.getElementById('lessonTitle');
      const descEl = document.getElementById('lessonDesc');
      if (titleEl) titleEl.innerText = `Bi ${lesson.index}: ${lesson.lessonName}`;
      if (descEl) descEl.innerText = "Ni dung chi tit bi hc s sm c cp nht.";

      // 3. Render Materials Tab
      const matArea = document.getElementById('materialsArea');
      if (lesson && lesson.materialUrl && matArea) {
        const lines = lesson.materialUrl.split('\n');
        let html = '';
        lines.forEach((line, idx) => {
          if (!line.trim()) return;
          let name = 'Ti liu hc tp ' + (idx + 1);
          let url = line.trim();
          if (line.includes('|')) { const parts = line.split('|'); name = parts[0].trim(); url = parts[1].trim(); }

          html += `
             <a href="${url}" target="_blank" class="material-card">
                <div class="file-icon"></div>
                <div style="flex:1">
                   <div style="font-weight:600;color:var(--text-primary);font-size:14px">${escapeHtml(name)}</div>
                   <div style="font-size:12px;color:var(--text-muted)">Nhn  ti xung</div>
                </div>
                <i data-lucide="download" style="color:var(--text-muted)"></i>
             </a>
           `;
        });
        matArea.innerHTML = html;
        if (window.lucide) lucide.createIcons();
      } else if (matArea) {
        matArea.innerHTML = '<div class="muted">Khng c ti liu no.</div>';
      }

      // 4. Render Layout & Sidebar
      renderSidebarList(data, lessonIndex, []);

      // 5. Render Footer Actions (Placeholder)
      if (completeBtnContainer) {
        completeBtnContainer.innerHTML = '<button class="btn btn-red" style="width:100%;opacity:0.5">ang ti...</button>';
      }
    }

    // Helper: Render Sidebar List (New Design)
    function renderSidebarList(data, currentLessonIdx, progressList) {
      const sidebarList = document.getElementById('sidebarLessonList');
      if (!sidebarList) return;

      // Defensive checks
      if (!data || !data.lessons || !Array.isArray(data.lessons)) {
        console.error('Invalid data in renderSidebarList:', data);
        return;
      }

      let sidebarHtml = '';
      data.lessons.forEach(l => {
        const isCurrent = l.index === currentLessonIdx;

        // Check if lesson is completed (more robust check)
        const isDone = progressList && progressList.some(p =>
          p.lessonIndex === l.index &&
          p.completedAt &&
          String(p.completedAt).trim() !== '' &&
          String(p.completedAt).trim() !== '0'
        );

        let statusIcon = '<div class="btn-circle" style="width:24px;height:24px;border:none;background:rgba(255,255,255,0.1)"><i data-lucide="play" size="12"></i></div>';
        let itemClass = 'playlist-item';

        if (isCurrent && isDone) {
          // Current lesson AND completed  Show green check
          itemClass += ' active checked';
          statusIcon = '<div style="color:var(--success)"><i data-lucide="check-circle-2"></i></div>';
        } else if (isCurrent) {
          // Current lesson but not completed  Show red bar chart
          itemClass += ' active';
          statusIcon = '<div style="color:var(--brand-red)"><i data-lucide="bar-chart-2"></i></div>';
        } else if (isDone) {
          // Not current but completed  Show green check
          itemClass += ' checked';
          statusIcon = '<div style="color:var(--success)"><i data-lucide="check-circle-2"></i></div>';
        }

        sidebarHtml += `
          <div class="${itemClass}" onclick="openLesson('${data.courseName}', ${l.index})">
            <div class="playlist-status">${statusIcon}</div>
            <div class="playlist-info">
               <div class="playlist-title">Bi ${l.index}: ${escapeHtml(l.lessonName)}</div>
               <div class="playlist-meta">${isDone ? ' hon thnh' : 'Cha hc'}</div>
            </div>
          </div>
        `;
      });
      sidebarList.innerHTML = sidebarHtml;
      if (window.lucide) lucide.createIcons();
    }

    // Helper: Lu progress m thm
    function saveLessonProgress(courseCode, lessonIndex, time, completed) {
      if (!courseCode || !state.user || !state.user.email) return Promise.reject('Invalid params');
      return callAPI('saveProgress', {
        email: state.user.email,
        courseCode: courseCode,
        lessonIndex: lessonIndex,
        videoTime: time,
        completed: completed
      });
    }

    // Action: Bm hon thnh
    async function markLessonComplete(lessonIndex, courseCode) {
      const btn = document.querySelector('.btn-complete');
      const originalText = btn.innerText;
      btn.innerText = 'ang lu...';
      btn.disabled = true;

      try {
        await callAPI('saveProgress', {
          email: state.user.email,
          courseCode: courseCode,
          lessonIndex: lessonIndex,
          videoTime: 0,
          completed: true
        });

        btn.innerText = '  HON THNH';
        btn.style.background = '#22c55e';

        // T ng chuyn bi tip theo sau 1s
        setTimeout(() => {
          const nextLesson = lessonIndex + 1;
          // Kim tra xem c bi tip theo khng (n gin, nu API openLesson fail th n s bo li, ko sao)
          openLesson(state.course, nextLesson);
        }, 1000);

      } catch (e) {
        alert('Li lu tin : ' + e);
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    function toImgUrl(driveUrl) {
      const id = (driveUrl.match(/\/d\/([a-zA-Z0-9_-]+)/) || [])[1];
      if (!id) return driveUrl;
      return 'https://drive.google.com/thumbnail?id=' + id + '&sz=w400';
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, function (m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }

    // Convert Google Drive share URL to direct image URL
    function convertDriveUrl(url) {
      if (!url) return 'https://via.placeholder.com/800x450?text=Course';

      const str = String(url).trim();

      // Already a direct URL (not Google Drive)
      if (!str.includes('drive.google.com')) {
        return str;
      }

      // Extract file ID from various Google Drive URL formats
      let fileId = null;

      // Format: https://drive.google.com/file/d/{ID}/view...
      const match1 = str.match(/\/file\/d\/([^\/\?]+)/);
      if (match1) fileId = match1[1];

      // Format: https://drive.google.com/open?id={ID}
      const match2 = str.match(/[?&]id=([^&]+)/);
      if (!fileId && match2) fileId = match2[1];

      if (fileId) {
        // Return direct thumbnail URL
        return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
      }

      // Can't parse, return original
      return str;
    }

    // --- TOAST NOTIFICATIONS HELPER ---
    window.showToast = function (message, type = 'info') {
      let container = document.querySelector('.toast-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
      }

      const toast = document.createElement('div');
      toast.className = 'toast ' + type;

      const icon = type === 'success' ? '' : (type === 'error' ? '' : (type === 'warning' ? '' : ''));

      toast.innerHTML =
        '<div style="font-size: 20px;">' + icon + '</div>' +
        '<div style="flex:1; font-weight: 500; line-height: 1.4;">' + escapeHtml(message) + '</div>';

      // Click  ng sm
      toast.onclick = function () {
        toast.style.animation = 'fadeOutUp 0.3s forwards';
        setTimeout(function () { if (toast.parentNode) toast.remove(); }, 300);
      };

      container.appendChild(toast);

      // Auto remove sau 3s (hoc 5s nu l error)
      const duration = type === 'error' ? 5000 : 3000;
      setTimeout(function () {
        if (toast.parentNode) {
          toast.style.animation = 'fadeOutUp 0.3s forwards';
          setTimeout(function () { if (toast.parentNode) toast.remove(); }, 300);
        }
      }, duration);
    };

    // --- COURSE REPORT MODAL (Premium Dashboard) ---
    let reportChartInstances = [];

    function createReportModal() {
      if (document.getElementById('reportModal')) return;

      // Add Chart.js if not loaded
      if (!window.Chart) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        document.head.appendChild(script);
      }

      const modalHTML = `
        <div id="reportModal" class="report-modal">
          <div class="report-container">
            <!-- Sidebar -->
            <aside class="report-sidebar">
              <div class="report-sidebar-header">
                <span class="report-logo">iaction<span style="color:var(--brand-red)">Admin</span></span>
              </div>
              <nav class="report-nav">
                <div class="report-nav-label">Bo co Kha hc</div>
                <div class="report-nav-item active" data-tab="overview" onclick="switchReportTab('overview')">
                  <i data-lucide="layout-dashboard"></i> Tng quan
                </div>
                <div class="report-nav-item" data-tab="lessons" onclick="switchReportTab('lessons')">
                  <i data-lucide="book-open"></i> Bo co Bi hc
                </div>
                <div class="report-nav-item" data-tab="students" onclick="switchReportTab('students')">
                  <i data-lucide="users"></i> Bo co Hc vin
                </div>
                <div class="report-nav-divider"></div>
                <div class="report-nav-item" onclick="closeReportModal()">
                  <i data-lucide="arrow-left"></i> ng bo co
                </div>
              </nav>
            </aside>
            
            <!-- Main Content -->
            <main class="report-main">
              <header class="report-header">
                <div>
                  <div class="report-breadcrumb">Bo co <i data-lucide="chevron-right" style="width:12px;height:12px"></i> <span id="reportCourseName">-</span></div>
                  <h1 id="reportPageTitle" class="report-title">Tng quan hiu qu</h1>
                </div>
                <div class="report-header-actions">
                  <button onclick="closeReportModal()" class="report-btn-close"><i data-lucide="x"></i></button>
                </div>
              </header>
              
              <div class="report-content" id="reportContent">
                <div class="report-loading">
                  <i data-lucide="loader-2" class="spin"></i>
                  <span>ang ti bo co...</span>
                </div>
              </div>
            </main>
          </div>
        </div>
        
        <style>
          .report-modal { display:none; position:fixed; inset:0; background:#050507; z-index:9999; animation:fadeIn 0.3s ease; }
          .report-container { display:flex; height:100vh; font-family:inherit; }
          
          /* Sidebar */
          .report-sidebar { width:240px; background:#09090B; border-right:1px solid #1F1F23; display:flex; flex-direction:column; flex-shrink:0; }
          .report-sidebar-header { height:64px; display:flex; align-items:center; padding:0 20px; border-bottom:1px solid rgba(31,31,35,0.5); }
          .report-logo { font-size:18px; font-weight:900; letter-spacing:-0.5px; text-transform:uppercase; font-style:italic; color:white; }
          .report-nav { flex:1; padding:20px 12px; }
          .report-nav-label { font-size:10px; text-transform:uppercase; font-weight:700; color:#3F3F46; letter-spacing:0.1em; padding:0 12px 8px; }
          .report-nav-item { display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:8px; font-size:13px; font-weight:500; color:#71717A; cursor:pointer; transition:all 0.2s; margin-bottom:4px; border-left:3px solid transparent; }
          .report-nav-item:hover { background:#18181B; color:white; }
          .report-nav-item.active { background:linear-gradient(90deg, rgba(220,38,38,0.15) 0%, transparent 100%); border-left-color:#DC2626; color:white; font-weight:600; }
          .report-nav-item.active i { color:#DC2626; }
          .report-nav-item i { width:18px; height:18px; }
          .report-nav-divider { height:1px; background:#1F1F23; margin:16px; }
          
          /* Main */
          .report-main { flex:1; display:flex; flex-direction:column; overflow:hidden; background:#050507; }
          .report-header { height:64px; padding:0 32px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #1F1F23; background:rgba(5,5,7,0.8); backdrop-filter:blur(10px); }
          .report-breadcrumb { font-size:11px; color:#52525B; display:flex; align-items:center; gap:6px; margin-bottom:2px; }
          .report-title { font-size:16px; font-weight:700; color:white; display:flex; align-items:center; gap:8px; }
          .report-header-actions { display:flex; gap:8px; }
          .report-btn-close { width:32px; height:32px; border-radius:8px; background:#18181B; border:1px solid #27272A; display:flex; align-items:center; justify-content:center; color:#71717A; cursor:pointer; transition:all 0.2s; }
          .report-btn-close:hover { background:#27272A; color:white; }
          .report-btn-close i { width:16px; height:16px; }
          
          /* Content */
          .report-content { flex:1; overflow-y:auto; padding:24px 32px; }
          .report-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; gap:16px; color:#52525B; }
          .report-loading .spin { animation:spin 1s linear infinite; width:32px; height:32px; }
          @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
          
          /* Tab Panels */
          .report-tab { display:none; animation:fadeIn 0.3s ease; }
          .report-tab.active { display:block !important; }
          
          /* Cards */
          .report-card { background:#121216; border:1px solid #1F1F23; border-radius:16px; padding:20px; position:relative; overflow:hidden; transition:all 0.3s; }
          .report-card:hover { border-color:rgba(255,255,255,0.1); transform:translateY(-2px); }
          .report-card.blue { background:radial-gradient(circle at top right, rgba(59,130,246,0.15), rgba(18,18,22,0)); border-color:rgba(59,130,246,0.3); }
          .report-card.orange { background:radial-gradient(circle at top right, rgba(249,115,22,0.15), rgba(18,18,22,0)); border-color:rgba(249,115,22,0.3); }
          .report-card.green { background:radial-gradient(circle at top right, rgba(34,197,94,0.15), rgba(18,18,22,0)); border-color:rgba(34,197,94,0.3); }
          .report-card.purple { background:radial-gradient(circle at top right, rgba(168,85,247,0.15), rgba(18,18,22,0)); border-color:rgba(168,85,247,0.3); }
          .report-card-bg-icon { position:absolute; right:-10px; top:-10px; opacity:0.1; transition:opacity 0.3s; }
          .report-card:hover .report-card-bg-icon { opacity:0.2; }
          .report-card-value { font-size:36px; font-weight:900; color:white; margin-bottom:4px; position:relative; z-index:1; }
          .report-card-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; display:flex; align-items:center; gap:6px; position:relative; z-index:1; }
          .report-card-label i { width:14px; height:14px; }
          .report-card-label.blue { color:#60A5FA; }
          .report-card-label.orange { color:#FB923C; }
          .report-card-label.green { color:#4ADE80; }
          .report-card-label.purple { color:#C084FC; }
          
          /* Grid */
          .report-grid-4 { display:grid; grid-template-columns:repeat(4, 1fr); gap:20px; margin-bottom:24px; }
          .report-grid-5 { display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; margin-bottom:24px; }
          .report-grid-charts { display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px; }
          @media (max-width: 1200px) { .report-grid-4, .report-grid-5 { grid-template-columns:repeat(2, 1fr); } .report-grid-charts { grid-template-columns:1fr; } }
          
          /* Chart Container */
          .report-chart-container { background:#121216; border:1px solid #1F1F23; border-radius:16px; padding:24px; }
          .report-chart-title { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; color:white; border-left:4px solid #DC2626; padding-left:12px; margin-bottom:20px; }
          .report-chart-title.blue { border-left-color:#3B82F6; }
          
          /* Badges */
          .report-badge { padding:4px 10px; border-radius:6px; font-size:10px; font-weight:700; text-transform:uppercase; display:inline-flex; align-items:center; gap:4px; letter-spacing:0.05em; }
          .report-badge.success { background:rgba(34,197,94,0.1); color:#22c55e; border:1px solid rgba(34,197,94,0.2); }
          .report-badge.warning { background:rgba(234,179,8,0.1); color:#eab308; border:1px solid rgba(234,179,8,0.2); }
          .report-badge.danger { background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.2); }
          .report-badge.neutral { background:rgba(113,113,122,0.1); color:#a1a1aa; border:1px solid rgba(113,113,122,0.2); }
          
          /* Lesson Item */
          .report-lesson { padding:16px 0; border-bottom:1px solid #1F1F23; }
          .report-lesson:last-child { border-bottom:none; }
          .report-lesson-header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px; }
          .report-lesson-name { font-size:14px; font-weight:600; color:white; }
          .report-lesson-stats { display:flex; gap:20px; font-size:11px; color:#52525B; margin-top:4px; }
          .report-lesson-stats i { width:12px; height:12px; }
          .report-lesson-dropoff { font-size:11px; font-weight:700; }
          .report-lesson-bar { height:4px; background:#1F1F23; border-radius:2px; overflow:hidden; margin-top:10px; }
          .report-lesson-bar-fill { height:100%; border-radius:2px; position:relative; }
          .report-lesson-bar-fill::after { content:''; position:absolute; top:0; right:0; bottom:0; width:10px; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4)); }
          
          /* Table */
          .report-table { width:100%; border-collapse:collapse; }
          .report-table th { font-size:10px; text-transform:uppercase; font-weight:700; color:#52525B; letter-spacing:0.05em; padding:12px 16px; text-align:left; border-bottom:1px solid #1F1F23; }
          .report-table td { padding:16px; font-size:13px; color:#A1A1AA; border-bottom:1px solid rgba(31,31,35,0.5); }
          .report-table tr:hover { background:rgba(24,24,27,0.5); }
          .report-table .email { color:rgba(255,255,255,0.8); font-weight:500; }
          .report-table .name { color:white; font-weight:600; }
          .report-progress-mini { display:flex; align-items:center; gap:8px; }
          .report-progress-mini-bar { width:60px; height:6px; background:#18181B; border-radius:3px; overflow:hidden; }
          .report-progress-mini-fill { height:100%; border-radius:3px; }
        </style>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function switchReportTab(tabName) {
      console.log(` [switchReportTab] Input: ${tabName}`);

      // Hide all tabs - CLEAR inline styles and remove active class
      document.querySelectorAll('.report-tab').forEach(t => {
        t.removeAttribute('style'); // Clear any inline display styles
        t.classList.remove('active');
      });

      // Remove active from nav
      document.querySelectorAll('.report-nav-item').forEach(n => n.classList.remove('active'));

      // Show selected tab - just add active class (CSS .report-tab.active handles display:block)
      const tabId = 'report-tab-' + tabName;
      const tab = document.getElementById(tabId);
      if (tab) {
        console.log(` [switchReportTab] Target found: ${tabId}`);
        tab.classList.add('active');
        tab.style.display = 'block'; // BACKUP: Direct style override
        console.log(` [switchReportTab] Added .active class + display:block. classList:`, tab.classList.toString());
      } else {
        console.error(` [switchReportTab] Target NOT found: ${tabId}`);
      }

      // Activate nav item
      const nav = document.querySelector(`.report-nav-item[data-tab="${tabName}"]`);
      if (nav) nav.classList.add('active');

      // Update title
      const titles = { overview: 'Tng quan hiu qu', lessons: 'Bo co chi tit Bi hc', students: 'Qun l Hc vin' };
      document.getElementById('reportPageTitle').textContent = titles[tabName] || 'Bo co';

      // Reinit icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function openCourseReport(courseName, courseCode, event) {
      if (event) event.stopPropagation();

      createReportModal();
      const modal = document.getElementById('reportModal');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';

      // Set course name in breadcrumb
      document.getElementById('reportCourseName').textContent = courseName;

      try {
        const data = await callAPI('getCourseReport', { courseCode: courseCode });

        if (data.success) {
          renderCourseReport(data.report, courseName);
        } else {
          document.getElementById('reportContent').innerHTML = `
            <div class="report-loading" style="color:#ef4444">
              <i data-lucide="alert-circle" style="width:48px;height:48px"></i>
              <span>Li: ${escapeHtml(data.message || 'Khng th ti bo co')}</span>
            </div>
          `;
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }
      } catch (err) {
        console.error('Report error:', err);
        document.getElementById('reportContent').innerHTML = `
          <div class="report-loading" style="color:#ef4444">
            <i data-lucide="wifi-off" style="width:48px;height:48px"></i>
            <span>Li kt ni: ${escapeHtml(err.message)}</span>
          </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    }

    // Helper to render lessons list (Extracted for clarity)
    function renderLessonsList(analytics) {
      if (!analytics || analytics.length === 0) {
        return '<div style="text-align:center;color:#52525B;padding:40px">Cha c d liu bi hc</div>';
      }
      return analytics.map((l, i) => {
        const dropColor = l.dropOffRate > 50 ? '#ef4444' : l.dropOffRate > 25 ? '#f59e0b' : '#22c55e';
        const barWidth = l.views > 0 ? Math.round((l.completions / l.views) * 100) : 0;
        const barColor = barWidth === 100 ? '#22c55e' : barWidth > 50 ? '#f59e0b' : '#3F3F46';
        return `
          <div class="report-lesson">
            <div class="report-lesson-header">
              <div>
                <div class="report-lesson-name" style="display:flex;align-items:center;gap:8px">
                  <span>Bi ${l.index}: ${escapeHtml(l.name)}</span>
                  <button class="btn-lesson-detail-mini" onclick="openLessonDetail(${i})" title="Xem chi tit">
                    <i data-lucide="bar-chart-2" style="width:14px;height:14px"></i>
                  </button>
                </div>
                <div class="report-lesson-stats">
                  <span style="display:flex;align-items:center;gap:4px"><i data-lucide="eye" style="width:12px;height:12px"></i> ${l.views} lt xem</span>
                  <span style="display:flex;align-items:center;gap:4px"><i data-lucide="check-circle" style="width:12px;height:12px;color:#22c55e"></i> ${l.completions} hon thnh</span>
                </div>
              </div>
            </div>
            <!-- Optional Progress Bar Visual (can add back if needed) -->
          </div>
        `;
      }).join('');
    }

    function renderCourseReport(report, courseName) {
      window._currentReport = report; // Store for detail view access
      const content = document.getElementById('reportContent');
      const completionRate = report.totalStudents > 0 ? Math.round((report.completedStudents / report.totalStudents) * 100) : 0;

      // Status helper
      const getStatus = (s) => {
        if (s.progress >= 100) return { badge: 'success', icon: 'check', text: 'Hon thnh' };
        // Active: Activity within 7 days (even if progress is 0%)
        if (s.daysSinceLastActivity <= 7) return { badge: 'warning', icon: 'book-open', text: 'ang hc (Active)' };
        // Dormant: Has started (has lastActivity) but inactive > 7 days
        if (s.lastActivity) return { badge: 'neutral', icon: 'moon', text: 'Ng ng' };
        return { badge: 'danger', icon: 'circle', text: 'Cha bt u' };
      };

      // Calculate distribution for chart
      const notStartedPct = report.totalStudents > 0 ? Math.round((report.notStartedStudents / report.totalStudents) * 100) : 0;
      const activePct = report.totalStudents > 0 ? Math.round((report.activeStudents / report.totalStudents) * 100) : 0;
      const completedPct = report.totalStudents > 0 ? Math.round((report.completedStudents / report.totalStudents) * 100) : 0;

      //  DEBUG: Student Data (STRICT LOGGING)
      console.log(' [renderCourseReport] Start');
      console.log(' [renderCourseReport] Students Array:', report.students);
      console.log(' [renderCourseReport] Total Students:', report.totalStudents);

      // Students tab will use class-based visibility (same as Overview/Lessons)

      content.innerHTML = `
        <!-- TAB 1: OVERVIEW -->
        <div id="report-tab-overview" class="report-tab active">
          <!-- Big Metric Cards -->
          <div class="report-grid-4">
            <div class="report-card blue">
              <div class="report-card-bg-icon"><i data-lucide="users" style="width:80px;height:80px;color:#3B82F6"></i></div>
              <div class="report-card-value">${report.totalStudents}</div>
              <div class="report-card-label blue"><i data-lucide="users"></i> Tng hc vin</div>
            </div>
            <div class="report-card orange">
              <div class="report-card-bg-icon"><i data-lucide="book-open" style="width:80px;height:80px;color:#F97316"></i></div>
              <div class="report-card-value">${report.activeStudents}</div>
              <div class="report-card-label orange"><i data-lucide="book-open"></i> ang hc</div>
            </div>
            <div class="report-card green">
              <div class="report-card-bg-icon"><i data-lucide="check-circle" style="width:80px;height:80px;color:#22C55E"></i></div>
              <div class="report-card-value">${report.completedStudents}</div>
              <div class="report-card-label green"><i data-lucide="check-circle"></i> Hon thnh</div>
            </div>
            <div class="report-card purple">
              <div class="report-card-bg-icon"><i data-lucide="trending-up" style="width:80px;height:80px;color:#A855F7"></i></div>
              <div class="report-card-value">${completionRate}%</div>
              <div class="report-card-label purple"><i data-lucide="activity"></i> T l hon thnh</div>
            </div>
          </div>
          
          <!-- Secondary Stats -->
          <div class="report-grid-5">
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.notStartedStudents || 0}</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="circle" style="width:12px;height:12px"></i> Cha bt u</div>
            </div>
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.dormantStudents || 0}</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="moon" style="width:12px;height:12px"></i> Ng ng</div>
            </div>
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.averageProgress || 0}%</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="bar-chart-2" style="width:12px;height:12px"></i> Tin  TB</div>
            </div>
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.totalLessons}</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="list" style="width:12px;height:12px"></i> Tng bi hc</div>
            </div>
            <div class="report-card" style="text-align:center;border-color:rgba(34,197,94,0.2);background:rgba(34,197,94,0.05)">
              <div style="font-size:24px;font-weight:700;color:#22c55e;margin-bottom:4px">${report.completionsThisWeek || 0}</div>
              <div style="font-size:10px;color:#22c55e;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="calendar" style="width:12px;height:12px"></i> Xong tun ny</div>
            </div>
          </div>
          
          <!-- Charts -->
          <div class="report-grid-charts">
            <div class="report-chart-container">
              <div class="report-chart-title">Hot ng hc tp</div>
              <div style="height:250px"><canvas id="reportActivityChart"></canvas></div>
            </div>
            <div class="report-chart-container">
              <div class="report-chart-title blue">Phn b tin </div>
              <div style="height:200px;display:flex;align-items:center;justify-content:center;position:relative">
                <canvas id="reportDistChart"></canvas>
                <div style="position:absolute;text-align:center">
                  <div style="font-size:24px;font-weight:900;color:white">${report.totalStudents}</div>
                  <div style="font-size:10px;color:#52525B;text-transform:uppercase">TNG HV</div>
                </div>
              </div>
              <div style="margin-top:20px;padding:0 16px">
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:8px">
                  <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444"></span><span style="color:#52525B">Cha bt u</span></span>
                  <span style="font-weight:700;color:white">${notStartedPct}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:8px">
                  <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span><span style="color:#52525B">ang hc</span></span>
                  <span style="font-weight:700;color:white">${activePct}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px">
                  <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e"></span><span style="color:#52525B">Hon thnh</span></span>
                  <span style="font-weight:700;color:white">${completedPct}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- TAB 2: LESSONS -->
        <div id="report-tab-lessons" class="report-tab" style="display:none">
          <div class="report-card" style="padding:32px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid #1F1F23">
              <div style="background:rgba(220,38,38,0.1);padding:10px;border-radius:10px">
                <i data-lucide="book-open" style="width:20px;height:20px;color:#DC2626"></i>
              </div>
              <div>
                <div style="font-size:16px;font-weight:700;color:white">Phn tch chi tit bi hc</div>
                <div style="font-size:12px;color:#52525B">Theo di mc  tng tc v t l b d tng bi</div>
              </div>
            </div>
            
            <div>
              ${renderLessonsList(report.lessonAnalytics)}
            </div>
          </div>
        </div>
        
        <!-- TAB 3: STUDENTS -->
        <div id="report-tab-students" class="report-tab">
          <div class="report-card" style="padding:24px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
              <div style="display:flex;align-items:center;gap:12px">
                <div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:10px">
                  <i data-lucide="users" style="width:20px;height:20px;color:#3B82F6"></i>
                </div>
                <div>
                  <div style="font-size:16px;font-weight:700;color:white">Danh sch hc vin (${report.students ? report.students.length : 0})</div>
                  <div style="font-size:12px;color:#52525B">Qun l tin  v trng thi hc tp</div>
                </div>
              </div>
            </div>
            
            <div style="overflow-x:auto">
              <table class="report-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Tn</th>
                    <th>Tin </th>
                    <th>Trng thi</th>
                    <th style="text-align:right">Ln hc cui</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <!-- Will be populated by renderStudentsTable() -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

      //  DEBUG: Render Students Table separately
      console.log(' [StudentsTab] Starting to render students table...');
      const studentsBody = document.getElementById('studentsTableBody');
      if (studentsBody && report.students) {
        console.log(' [StudentsTab] Students data:', report.students.length, 'students');

        if (report.students.length === 0) {
          studentsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#52525B">Cha c hc vin no</td></tr>';
        } else {
          let html = '';
          report.students.forEach((s, idx) => {
            if (idx === 0) console.log(' [StudentsTab] First student sample:', s);

            const st = getStatus(s);
            const barColor = s.progress >= 100 ? '#22c55e' : s.progress > 0 ? '#3b82f6' : '#27272A';

            html += `
              <tr>
                <td style="color:#A1A1AA">${escapeHtml(s.email || '-')}</td>
                <td style="color:white;font-weight:500">${escapeHtml(s.name || '-')}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:8px">
                    <div style="flex:1;height:6px;background:#27272A;border-radius:3px;overflow:hidden">
                      <div style="height:100%;width:${s.progress || 0}%;background:${barColor};border-radius:3px"></div>
                    </div>
                    <span style="font-size:12px;font-weight:600;color:${s.progress > 0 ? 'white' : '#52525B'}">${s.progress || 0}%</span>
                  </div>
                </td>
                <td><span class="report-badge ${st.badge}"><i data-lucide="${st.icon}" style="width:12px;height:12px"></i> ${st.text}</span></td>
                <td style="text-align:right;font-family:monospace;font-size:12px;color:#71717A">${s.lastActivity || '-'}</td>
              </tr>
            `;
          });
          studentsBody.innerHTML = html;
          console.log(' [StudentsTab] Rendered', report.students.length, 'students successfully');
        }
      } else {
        console.warn(' [StudentsTab] Missing studentsBody element or students data');
      }

      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Initialize Charts (with delay for Chart.js loading)
      setTimeout(() => initReportCharts(report), 100);
    }

    function initReportCharts(report) {
      // Destroy previous chart instances
      reportChartInstances.forEach(c => c.destroy());
      reportChartInstances = [];

      if (typeof Chart === 'undefined') {
        console.log('Chart.js not loaded yet');
        return;
      }

      // Activity Chart (Line)
      // Activity Chart (Line) - REAL DATA
      const activityCtx = document.getElementById('reportActivityChart');
      if (activityCtx) {
        // Calculate Data
        const chartLabels = [];
        const chartData = [];
        const now = new Date();
        const allActivities = [];
        if (report.lessonAnalytics) {
          report.lessonAnalytics.forEach(l => {
            if (l.details) l.details.forEach(d => { if (d.lastUpdateTs) allActivities.push(d.lastUpdateTs); });
          });
        }
        console.log(' [Overview Chart] Total activities:', allActivities.length);

        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(now.getDate() - i);
          d.setHours(0, 0, 0, 0);
          const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
          chartLabels.push(dayNames[d.getDay()]);

          const nextD = new Date(d);
          nextD.setDate(d.getDate() + 1);
          const count = allActivities.filter(ts => ts >= d.getTime() && ts < nextD.getTime()).length;
          chartData.push(count);
          console.log(`   - ${dayNames[d.getDay()]}: ${count}`);
        }

        const ctx = activityCtx.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 250);
        gradient.addColorStop(0, 'rgba(34, 197, 94, 0.4)');
        gradient.addColorStop(1, 'rgba(34, 197, 94, 0)');

        const chart1 = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [{
              label: 'Hot ng hc tp',
              data: chartData,
              borderColor: '#22c55e',
              backgroundColor: gradient,
              borderWidth: 2,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#050507',
              pointBorderColor: '#22c55e',
              pointRadius: 4,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#52525B', font: { size: 10 } } },
              y: { grid: { color: '#1F1F23', borderDash: [5, 5] }, ticks: { color: '#52525B', font: { size: 10 } }, beginAtZero: true }
            }
          }
        });
        reportChartInstances.push(chart1);
      }

      // Distribution Chart (Doughnut)
      const distCtx = document.getElementById('reportDistChart');
      if (distCtx) {
        const chart2 = new Chart(distCtx, {
          type: 'doughnut',
          data: {
            labels: ['Cha bt u', 'ang hc', 'Hon thnh'],
            datasets: [{
              data: [report.notStartedStudents || 0, report.activeStudents || 0, report.completedStudents || 0],
              backgroundColor: ['#ef4444', '#3b82f6', '#22c55e'],
              borderColor: '#121216',
              borderWidth: 4,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: { legend: { display: false } }
          }
        });
        reportChartInstances.push(chart2);
      }
    }

    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
      // Destroy charts
      reportChartInstances.forEach(c => c.destroy());
      reportChartInstances = [];
    }

    // --- SEARCH LOGIC ---
    let searchTimeout;
    async function handleSearch(keyword) {
      const dropdown = document.getElementById('searchDropdown');
      if (!dropdown) return;

      if (!keyword || keyword.trim().length < 2) {
        dropdown.classList.remove('active');
        return;
      }

      if (searchTimeout) clearTimeout(searchTimeout);

      searchTimeout = setTimeout(async () => {
        try {
          dropdown.classList.add('active');
          dropdown.innerHTML = '<div style="padding:16px;color:#888;text-align:center"> ang tm...</div>';

          const result = await callAPI('search', { keyword });

          if (!result.success || !result.results || result.results.length === 0) {
            dropdown.innerHTML = '<div style="padding:16px;color:#888;text-align:center">Khng tm thy kt qu</div>';
            return;
          }

          let html = '';
          result.results.forEach(item => {
            const isLesson = item.type === 'lesson';
            const tag = isLesson ? 'BI HC' : 'KHA HC';
            // Escape single quotes for onclick handler safely
            const safeCourseName = escapeHtml(item.courseName).replace(/'/g, "\\'");

            const clickAction = isLesson
              ? `openLesson('${safeCourseName}', ${item.lessonIndex})`
              : `openCourse('${safeCourseName}')`;

            const thumb = item.thumbnail ? toImgUrl(item.thumbnail) : '';
            const imgHtml = thumb ? `<img src="${thumb}">` : `<div style="width:40px;height:40px;background:#333;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px">${isLesson ? '' : ''}</div>`;

            html += `
                  <div class="search-item" onclick="${clickAction}; document.getElementById('searchDropdown').classList.remove('active')">
                     ${imgHtml}
                     <div class="search-meta">
                        <div class="search-title">${escapeHtml(item.title)}</div>
                        <div class="search-subtitle">${escapeHtml(item.subtitle)}</div>
                     </div>
                     <div class="search-tag">${tag}</div>
                  </div>
                `;
          });
          dropdown.innerHTML = html;

        } catch (e) {
          console.error(e);
          dropdown.innerHTML = '<div style="padding:12px;color:#ef4444;text-align:center">Li tm kim</div>';
        }
      }, 400); // 400ms debounce
    }

    // Click outside to close search
    document.addEventListener('click', function (e) {
      const wrapper = document.querySelector('.search-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        const dd = document.getElementById('searchDropdown');
        if (dd) dd.classList.remove('active');
      }
    });

    function openLessonDetail(index) {
      const report = window._currentReport;
      if (!report || !report.lessonAnalytics || !report.lessonAnalytics[index]) return;

      const l = report.lessonAnalytics[index];
      const details = l.details || [];

      // Parse date from "dd/MM/yyyy HH:mm" format
      function parseDate(str) {
        if (!str) return null;
        console.log('Parsing date:', str);
        // Flexible regex for d/m/y or dd/mm/yyyy with / or -
        const parts = str.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*(\d{1,2})?:?(\d{1,2})?/);
        if (!parts) return null;
        return new Date(parts[3], parts[2] - 1, parts[1], parts[4] || 0, parts[5] || 0);
      }

      // Build chart data for given range
      function buildChartData(rangeDays) {
        const labels = [];
        const data = [];
        const now = new Date();
        now.setHours(23, 59, 59, 999);

        console.log(' [DEBUG] Building chart, range:', rangeDays, 'days, now:', now);
        console.log(' [DEBUG] Total details:', details.length, 'Sample:', details[0]);

        for (let i = rangeDays - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(now.getDate() - i);
          d.setHours(0, 0, 0, 0);
          const nextD = new Date(d);
          nextD.setDate(d.getDate() + 1);

          // Format label based on range
          const label = rangeDays <= 7
            ? d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })
            : rangeDays <= 30
              ? d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })
              : d.toLocaleDateString('vi-VN', { month: 'short' });
          labels.push(label);

          // Count activities in this day (use timestamp for reliable comparison)
          const matchedEntries = [];
          const count = details.filter(det => {
            if (!det.lastUpdateTs) {
              console.warn(' Missing lastUpdateTs:', det);
              return false;
            }
            const detDate = new Date(det.lastUpdateTs);
            const match = detDate >= d && detDate < nextD;
            if (match) {
              matchedEntries.push({ email: det.email, date: detDate.toLocaleString('vi-VN') });
            }
            return match;
          }).length;

          console.log(` ${label} [${d.toLocaleDateString('vi-VN')}]: ${count} activities`);
          if (count > 0) {
            console.log('    Matched entries:', matchedEntries);
          }
          data.push(count);
        }

        console.log(' Labels:', labels, 'Data:', data);
        return { labels, data };
      }

      // Create modal if not exists
      if (!document.getElementById('lessonDetailModal')) {
        const div = document.createElement('div');
        div.id = 'lessonDetailModal';
        div.className = 'modal-overlay-2';
        div.innerHTML = `
          <div class="report-card" style="width:900px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;padding:0;overflow:hidden;background:#09090b;border:1px solid #27272a">
            <div style="padding:16px 24px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center;background:#18181b">
               <div>
                  <h3 style="margin:0;color:white;font-size:18px" id="ldTitle">Chi tit bi hc</h3>
                  <div style="font-size:12px;color:#a1a1aa;margin-top:4px">Thng k chi tit hc vin</div>
               </div>
               <button onclick="closeLessonDetail()" style="background:none;border:none;color:#52525b;cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s" onmouseover="this.style.background='#27272a';this.style.color='white'" onmouseout="this.style.background='none';this.style.color='#52525b'">
                  <i data-lucide="x" style="width:20px;height:20px"></i>
               </button>
            </div>
            <div style="flex:1;overflow-y:auto;padding:0" id="ldContent"></div>
          </div>
        `;
        document.body.appendChild(div);
      }

      // Populate Data
      document.getElementById('ldTitle').textContent = l.name;

      const views = l.views;
      const completes = l.completions;
      const viewingStudents = details.filter(d => !d.isCompleted);
      const completedStudents = details.filter(d => d.isCompleted);

      // Initial chart data (7 days)
      let currentRange = 7;
      let chartData = buildChartData(currentRange);

      const content = document.getElementById('ldContent');
      content.innerHTML = `
        <div style="padding:24px">
           <!-- Metrics Row -->
           <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px">
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">Tng lt xem</div>
                 <div style="font-size:24px;font-weight:700;color:white">${views}</div>
              </div>
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">ang xem</div>
                 <div style="font-size:24px;font-weight:700;color:#3b82f6">${viewingStudents.length}</div>
              </div>
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">Hon thnh</div>
                 <div style="font-size:24px;font-weight:700;color:#22c55e">${completedStudents.length}</div>
              </div>
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">T l b d</div>
                 <div style="font-size:24px;font-weight:700;color:${l.dropOffRate > 50 ? '#ef4444' : '#f59e0b'}">${l.dropOffRate}%</div>
              </div>
           </div>

           <!-- Chart Section with Range Selector -->
           <div style="background:#18181b;border-radius:12px;border:1px solid #27272a;padding:20px;margin-bottom:24px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                 <div style="font-size:14px;font-weight:600;color:white">Xu hng truy cp</div>
                 <div style="display:flex;gap:8px">
                    <button class="ld-range-btn active" data-range="7" style="padding:6px 12px;border-radius:6px;border:1px solid #3b82f6;background:rgba(59,130,246,0.2);color:#3b82f6;cursor:pointer;font-size:12px">7 ngy</button>
                    <button class="ld-range-btn" data-range="30" style="padding:6px 12px;border-radius:6px;border:1px solid #27272a;background:transparent;color:#71717a;cursor:pointer;font-size:12px">30 ngy</button>
                    <button class="ld-range-btn" data-range="90" style="padding:6px 12px;border-radius:6px;border:1px solid #27272a;background:transparent;color:#71717a;cursor:pointer;font-size:12px">3 thng</button>
                 </div>
              </div>
              <div style="height:200px">
                 <canvas id="lessonTrendChart"></canvas>
              </div>
           </div>

           <!-- Student Tabs -->
           <div style="background:#18181b;border-radius:12px;border:1px solid #27272a;overflow:hidden">
              <div style="display:flex;border-bottom:1px solid #27272a">
                 <button class="ld-tab-btn active" data-tab="viewing" style="flex:1;padding:12px;background:rgba(59,130,246,0.1);border:none;color:#3b82f6;cursor:pointer;font-weight:600;font-size:13px">
                    ang xem (${viewingStudents.length})
                 </button>
                 <button class="ld-tab-btn" data-tab="completed" style="flex:1;padding:12px;background:transparent;border:none;color:#71717a;cursor:pointer;font-weight:600;font-size:13px">
                    Hon thnh (${completedStudents.length})
                 </button>
              </div>
              <div id="ldTabContent" style="max-height:300px;overflow-y:auto">
                 <!-- Tab content will be rendered here -->
              </div>
           </div>
        </div>
      `;

      // Render student list for a tab
      function renderStudentList(students, showCompletedAt) {
        if (students.length === 0) {
          return '<div style="padding:40px;text-align:center;color:#52525b">Khng c hc vin</div>';
        }
        return '<table style="width:100%;border-collapse:collapse;font-size:13px">' +
          '<thead style="background:#27272a;color:#a1a1aa;text-align:left;position:sticky;top:0">' +
          '<tr>' +
          '<th style="padding:12px 16px">Hc vin</th>' +
          '<th style="padding:12px 16px;text-align:right">' + (showCompletedAt ? 'Hon thnh lc' : 'Cp nht cui') + '</th>' +
          '</tr>' +
          '</thead>' +
          '<tbody>' +
          students.map(d =>
            '<tr style="border-bottom:1px solid #27272a;color:#e4e4e7">' +
            '<td style="padding:12px 16px">' +
            '<div style="font-weight:500">' + escapeHtml(d.name) + '</div>' +
            '<div style="font-size:11px;color:#71717a">' + escapeHtml(d.email) + '</div>' +
            '</td>' +
            '<td style="padding:12px 16px;text-align:right;color:#71717a;font-family:monospace">' +
            (showCompletedAt ? (d.completedAt || '-') : (d.lastUpdate || '-')) +
            '</td>' +
            '</tr>'
          ).join('') +
          '</tbody>' +
          '</table>';
      }

      // Initial render viewing tab
      document.getElementById('ldTabContent').innerHTML = renderStudentList(viewingStudents, false);

      // Tab switching
      document.querySelectorAll('.ld-tab-btn').forEach(btn => {
        btn.onclick = function () {
          document.querySelectorAll('.ld-tab-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = 'transparent';
            b.style.color = '#71717a';
          });
          this.classList.add('active');
          this.style.background = this.dataset.tab === 'viewing' ? 'rgba(59,130,246,0.1)' : 'rgba(34,197,94,0.1)';
          this.style.color = this.dataset.tab === 'viewing' ? '#3b82f6' : '#22c55e';

          document.getElementById('ldTabContent').innerHTML = this.dataset.tab === 'viewing'
            ? renderStudentList(viewingStudents, false)
            : renderStudentList(completedStudents, true);
        };
      });

      // Chart init & range switching
      function initChart(labels, data) {
        const ctx = document.getElementById('lessonTrendChart').getContext('2d');
        if (window.lessonChartInstance) window.lessonChartInstance.destroy();

        window.lessonChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Lt tng tc',
              data: data,
              backgroundColor: '#3b82f6',
              borderRadius: 4,
              barThickness: labels.length > 30 ? 8 : labels.length > 14 ? 12 : 20
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#71717a', maxRotation: 45 } },
              y: { grid: { color: '#27272a' }, ticks: { color: '#71717a', stepSize: 1 } }
            }
          }
        });
      }

      initChart(chartData.labels, chartData.data);

      // Range button click handlers
      document.querySelectorAll('.ld-range-btn').forEach(btn => {
        btn.onclick = function () {
          document.querySelectorAll('.ld-range-btn').forEach(b => {
            b.classList.remove('active');
            b.style.border = '1px solid #27272a';
            b.style.background = 'transparent';
            b.style.color = '#71717a';
          });
          this.classList.add('active');
          this.style.border = '1px solid #3b82f6';
          this.style.background = 'rgba(59,130,246,0.2)';
          this.style.color = '#3b82f6';

          const range = parseInt(this.dataset.range);
          const newData = buildChartData(range);
          initChart(newData.labels, newData.data);
        };
      });

      document.getElementById('lessonDetailModal').style.display = 'flex';
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeLessonDetail() {
      const m = document.getElementById('lessonDetailModal');
      if (m) m.style.display = 'none';
      if (window.lessonChartInstance) {
        window.lessonChartInstance.destroy();
        window.lessonChartInstance = null;
      }
    }


    // Init - Optimized (renderHome handles profile sync internally)
    (async function init() {
      if (checkAuth()) {
        console.log(' Init: User authenticated, rendering...');

        const urlParams = new URLSearchParams(window.location.search);
        const initialView = urlParams.get('view');
        const initialTab = urlParams.get('tab') || 'overview';
        const initialCourse = urlParams.get('course');
        const initialLesson = parseInt(urlParams.get('lesson')) || 0;

        // Check if dashboard view requested
        if (initialView === 'dashboard') {
          showLoading();
          await syncUserProfile();
          hideLoading();

          // Only teachers can access dashboard
          if (isTeacher) {
            renderAdminDashboard(initialTab);
          } else {
            renderHome();
          }
        } else if (initialCourse) {
          // Nu c course/lesson trong URL, cn sync profile trc
          showLoading();
          await syncUserProfile();
          hideLoading();

          if (initialLesson > 0) {
            openLesson(initialCourse, initialLesson);
          } else {
            openCourse(initialCourse);
          }
        } else {
          // i thng vo renderHome ( ti u vi 1 API call)
          renderHome();
        }
      } else {
        renderLogin();
      }
    })();
  </script>

  <!-- MODAL ADD USER DIRECT -->
  <div class="profile-modal-overlay" id="modalAddUserDirect"
    onclick="if(event.target===this) closeModalAddUserDirect()">
    <div class="profile-modal" style="max-width:400px">
      <div style="padding:24px;border-bottom:1px solid #333">
        <h3 style="font-size:18px;font-weight:700;color:var(--text-primary)">Thm Hc Vin Mi</h3>
      </div>
      <form id="formAddUserDirect" style="padding:24px">
        <div class="form-group" style="margin-bottom:16px">
          <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-muted)">Email <span
              style="color:red">*</span></label>
          <input type="email" id="newUserDirectEmail" class="form-input" required placeholder="nhapemail@gmail.com"
            style="width:100%;padding:10px;background:var(--bg-800);border:1px solid var(--border);color:var(--text-primary);border-radius:6px">
        </div>
        <div class="form-group" style="margin-bottom:24px">
          <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-muted)">H v tn</label>
          <input type="text" id="newUserDirectName" class="form-input" placeholder="Nguyn Vn A"
            style="width:100%;padding:10px;background:var(--bg-800);border:1px solid var(--border);color:var(--text-primary);border-radius:6px">
        </div>
        <div id="addUserDirectMsg" style="margin-bottom:16px"></div>
        <div style="display:flex;justify-content:flex-end;gap:12px">
          <button type="button" class="btn" onclick="closeModalAddUserDirect()"
            style="background:var(--bg-700);color:var(--text-primary);border:1px solid var(--border)">Hy</button>
          <button type="submit" class="btn btn-primary" style="background:var(--brand-red);border:none;color:white">Thm
            ngay</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== ADD USER DIRECT LOGIC ==========
    function openModalAddUserDirect() {
      console.log(' [AddUserDirect] Opening modal...');
      document.getElementById('modalAddUserDirect').classList.add('active');
      document.getElementById('formAddUserDirect').reset();
      document.getElementById('addUserDirectMsg').innerHTML = '';
    }

    function closeModalAddUserDirect() {
      document.getElementById('modalAddUserDirect').classList.remove('active');
    }

    document.getElementById('formAddUserDirect').addEventListener('submit', async function (e) {
      e.preventDefault();
      const email = document.getElementById('newUserDirectEmail').value.trim();
      const name = document.getElementById('newUserDirectName').value.trim();
      const msgDiv = document.getElementById('addUserDirectMsg');

      console.log(' [AddUserDirect] Submitting form:', { email, name });

      if (!email) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui lng nhp Email!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success"> ang x l...</div>';

      try {
        // Reuse addStudentToSheet API
        const result = await callAPI('addStudentToSheet', { email, name });
        console.log(' [AddUserDirect] Result:', result);
        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success"> ' + result.message + '</div>';
          setTimeout(() => {
            closeModalAddUserDirect();
            // Reset cache to reload new user
            localStorage.removeItem('lms_users_cache');
            loadAdminUsers(true);
          }, 1500);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        console.error(' [AddUserDirect] Error:', error);
        msgDiv.innerHTML = '<div class="alert alert-error">Li: ' + error + '</div>';
      }
    });
    // ==========================================
    // EMAIL CONFIGURATION & IMAGE UPLOAD LOGIC
    // ==========================================

    // Load email settings
    async function loadEmailConfiguration() {
      try {
        const res = await callAPI('getEmailSettings');
        if (res.success) {
          const driveInput = document.getElementById('settingDriveFolder_v3');
          const headerInput = document.getElementById('settingEmailHeader');
          const footerInput = document.getElementById('settingEmailFooter');
          const senderInput = document.getElementById('emailSenderName');

          if (driveInput) driveInput.value = res.settings.driveFolderId || '';
          if (headerInput) headerInput.value = res.settings.emailHeader || 'LMS SYSTEM';
          if (footerInput) footerInput.value = res.settings.emailFooter || 'Designed with  by Vibe Code';

          // Only set sender if empty or default
          if (senderInput && res.settings.defaultSenderName && senderInput.value === 'AZ English Academy') {
            senderInput.value = res.settings.defaultSenderName;
          }

          console.log(' [EmailMkt] Config loaded');
        }
      } catch (e) { console.error('Error loading config:', e); }
    }

    // Save email settings (Renamed to bust cache)
    async function handleSaveEmailConfig() {
      console.log(' [EmailMkt v2.2] Button Clicked!');
      const folderEl = document.getElementById('settingDriveFolder_v3');
      const headerEl = document.getElementById('settingEmailHeader');
      const footerEl = document.getElementById('settingEmailFooter');
      const senderEl = document.getElementById('emailSenderName');

      const folderUrl = folderEl ? folderEl.value.trim() : "";
      const headerText = headerEl ? headerEl.value.trim() : "LMS SYSTEM";
      const footerText = footerEl ? footerEl.value.trim() : "Designed with  by Vibe Code";
      const senderName = senderEl ? senderEl.value.trim() : "";

      // DEBUG POPUP
      // alert('DEBUG CHECK v2.2:\nFolder Value: "' + folderUrl + '"');

      console.log(' [EmailMkt] Try Saving Config.', { folderUrl, headerText, footerText, senderName });

      if (!folderUrl) {
        showToast('Vui lng nhp Link Folder Drive!', 'warning');
        return;
      }

      showToast('ang lu cu hnh...', 'info');
      try {
        const payload = {
          driveFolderId: folderUrl,
          emailHeader: headerText,
          emailFooter: footerText,
          defaultSenderName: senderName
        };
        console.log(' [EmailMkt] Sending Payload:', payload);

        const res = await callAPI('saveEmailSettings', {
          settings: payload
        });

        if (res.success) {
          showToast(res.message, 'success');
          if (res.folderId && folderEl) {
            folderEl.value = res.folderId;
          }
        } else {
          showToast(res.message, 'error');
          console.error(' [EmailMkt] Backend Error:', res);
        }
      } catch (e) {
        console.error(' [EmailMkt] Frontend Error:', e);
        showToast('Li lu cu hnh: ' + e.toString(), 'error');
      }
    }

    // Handle Image Upload from Quill
    async function handleQuillImageUpload(input) {
      const file = input.files[0];
      if (!file) return;

      // Check file type/size
      if (file.size > 5 * 1024 * 1024) {
        showToast('nh qu ln (>5MB). Vui lng chn nh nh hn.', 'warning');
        return;
      }

      showToast('ang upload nh ln Drive...', 'info');

      // Show loading placeholder in Quill
      const range = quillEditor.getSelection(true);
      if (range) {
        quillEditor.insertText(range.index, '...Uploading Image...', 'bold', true);
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        const base64Data = e.target.result;

        try {
          const res = await callAPI('uploadImageToDrive', {
            base64Data: base64Data,
            fileName: file.name
          });

          // Remove placeholder
          if (range) quillEditor.deleteText(range.index, 21);

          if (res.success) {
            // Insert image with direct URL
            quillEditor.insertEmbed(range ? range.index : 0, 'image', res.url);
            showToast('Upload nh thnh cng!', 'success');
          } else {
            showToast(res.message, 'error');
          }
        } catch (err) {
          if (range) quillEditor.deleteText(range.index, 21);
          console.error('Upload Error:', err);
          showToast('Li upload nh: ' + err.message, 'error');
        }

        // Reset input
        input.value = '';
      };
      reader.readAsDataURL(file);
    }
    // ================================================================
    // OVERRIDE: ADVANCED EMAIL EDITOR LOGIC (Header/Footer) v3.0
    // ================================================================
    let quillHeader, quillFooter;
    let isQuillInitialized = false;

    function initEmailQuills() {
      if (isQuillInitialized) return;
      console.log(' [EmailEditor] Initializing Quills...');

      const toolbarOptions = [
        ['bold', 'italic', 'underline'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'align': [] }],
        ['image', 'link']
      ];

      // Header Editor
      if (document.getElementById('quill-header-container')) {
        quillHeader = new Quill('#quill-header-container', {
          theme: 'snow',
          modules: { toolbar: toolbarOptions },
          placeholder: 'Design your Header (Logo, Title)...'
        });
        // Handle Header Image Upload
        quillHeader.getModule('toolbar').addHandler('image', () => {
          selectImageForQuill(quillHeader);
        });
      }

      // Footer Editor
      if (document.getElementById('quill-footer-container')) {
        quillFooter = new Quill('#quill-footer-container', {
          theme: 'snow',
          modules: { toolbar: toolbarOptions },
          placeholder: 'Design your Footer (Copyright, Links)...'
        });
        // Handle Footer Image Upload
        quillFooter.getModule('toolbar').addHandler('image', () => {
          selectImageForQuill(quillFooter);
        });
      }

      isQuillInitialized = true;
    }

    // Reuse existing upload logic but adapt for specific quill instance
    function selectImageForQuill(targetQuillInstance) {
      const input = document.createElement('input');
      input.setAttribute('type', 'file');
      input.setAttribute('accept', 'image/*');
      input.click();

      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;

        // Check size
        if (file.size > 5 * 1024 * 1024) {
          showToast('nh qu ln (>5MB).', 'warning');
          return;
        }

        // Upload
        showToast('ang upload nh...', 'info');
        const range = targetQuillInstance.getSelection(true);

        // Loading text
        targetQuillInstance.insertText(range ? range.index : 0, '...Uploading...', 'bold', true);

        const reader = new FileReader();
        reader.onload = async function (e) {
          const base64Data = e.target.result;
          try {
            const res = await callAPI('uploadImageToDrive', {
              base64Data: base64Data,
              fileName: file.name
            });

            // Delete loading text (length 13)
            targetQuillInstance.deleteText(range ? range.index : 0, 13);

            if (res.success) {
              targetQuillInstance.insertEmbed(range ? range.index : 0, 'image', res.url);
            } else {
              showToast(res.message, 'error');
            }
          } catch (err) {
            targetQuillInstance.deleteText(range ? range.index : 0, 13);
            showToast('Li Upload: ' + err.message, 'error');
          }
        };
        reader.readAsDataURL(file);
      };
    }

    // Open Modal
    function openEmailSettingsModal() {
      console.log(' [EmailEditor] Open Modal');
      // Create Modal if not exists
      if (!document.getElementById('modalEmailSetup')) {
        createEmailSettingsModal();
      }
      document.getElementById('modalEmailSetup').style.display = 'flex';

      // Init Quills (must be visible to calculate dimensions)
      setTimeout(() => {
        initEmailQuills();
        loadEmailConfiguration(); // Load data into Quills
      }, 100);
    }

    function closeEmailSettingsModal() {
      const m = document.getElementById('modalEmailSetup');
      if (m) m.style.display = 'none';
    }

    function createEmailSettingsModal() {
      // Only create if not exists
      if (document.getElementById('modalEmailSetup')) return;

      const modalHTML = `
        <div id="modalEmailSetup" class="modal-overlay-2" style="display:none;z-index:9999; justify-content:center; align-items:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7)">
           <div class="report-card" style="width:800px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;padding:0;background:#121216;border:1px solid #27272a;box-shadow:0 20px 50px rgba(0,0,0,0.5);border-radius:12px">
              
              <!-- Header -->
              <div style="padding:16px 24px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center;background:#18181b">
                 <h3 style="margin:0;color:white;font-size:16px"><i data-lucide="mail" style="width:16px;vertical-align:middle;margin-right:8px"></i>Email Template Editor</h3>
                 <button onclick="closeEmailSettingsModal()" style="background:none;border:none;color:#52525b;cursor:pointer"><i data-lucide="x"></i></button>
              </div>

              <!-- Body (Scrollable) -->
              <div style="flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:24px">
                 
                 <!-- 1. General Config -->
                 <div>
                    <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;display:block">General Settings</label>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                       <div>
                          <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">Drive Folder URL (For Images)</label>
                          <input type="text" id="settingDriveFolder_v3" class="form-input" placeholder="https://drive.google.com/..." style="background:#09090b; width:100%">
                       </div>
                       <div>
                           <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">Default Sender Name</label>
                            <input type="text" id="emailSenderName_Modal" class="form-input" placeholder="LMS System" style="background:#09090b; width:100%">
                       </div>
                    </div>
                 </div>

                 <!-- 2. Header Editor -->
                 <div>
                    <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between">
                       <span>Header Design (600x150px)</span>
                       <span style="font-size:10px;color:var(--warning)">Required: Images will autofit height</span>
                    </label>
                    <div style="background:white;border-radius:8px;overflow:hidden;color:black">
                       <div id="quill-header-container" style="height:150px"></div>
                    </div>
                 </div>

                 <!-- 3. Footer Editor -->
                 <div>
                    <label style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;display:block">Footer Design</label>
                    <div style="background:white;border-radius:8px;overflow:hidden;color:black">
                       <div id="quill-footer-container" style="height:100px"></div>
                    </div>
                 </div>
              </div>

              <!-- Footer Actions -->
              <div style="padding:16px 24px;border-top:1px solid #27272a;background:#18181b;display:flex;justify-content:flex-end;gap:12px">
                 <button class="btn" onclick="closeEmailSettingsModal()" style="background:transparent;border:1px solid #27272a">Cancel</button>
                 <button class="btn" onclick="handleSaveEmailConfig()" style="background:var(--brand-red);color:white">
                    <i data-lucide="save" style="width:14px;margin-right:6px"></i> Save Configuration
                 </button>
              </div>
           </div>
        </div>
        `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      lucide.createIcons();
    }

    // Load email settings (OVERRIDE)
    async function loadEmailConfiguration() {
      console.log(' [EmailEditor] Loading Configuration...');
      try {
        const res = await callAPI('getEmailSettings');
        if (res.success) {
          // General
          const driveInput = document.getElementById('settingDriveFolder_v3'); // ID shared with old UI or new
          const senderInput = document.getElementById('emailSenderName_Modal');

          if (driveInput) driveInput.value = res.settings.driveFolderId || '';
          if (senderInput) senderInput.value = res.settings.defaultSenderName || 'LMS System';

          // Quills (Header/Footer)
          if (quillHeader && res.settings.emailHeader) {
            // Decode HTML entities if needed, but innerHTML handles basic ones
            quillHeader.root.innerHTML = res.settings.emailHeader;
          }
          if (quillFooter && res.settings.emailFooter) {
            quillFooter.root.innerHTML = res.settings.emailFooter;
          }

          console.log(' [EmailEditor] Config Loaded');
        }
      } catch (e) { console.error('Error loading config:', e); }
    }

    // Save email settings (OVERRIDE)
    async function handleSaveEmailConfig() {
      console.log(' [EmailEditor] Save Clicked!');

      const folderEl = document.getElementById('settingDriveFolder_v3');
      const senderEl = document.getElementById('emailSenderName_Modal');

      const folderUrl = folderEl ? folderEl.value.trim() : "";
      const senderName = senderEl ? senderEl.value.trim() : "";

      if (!isQuillInitialized) {
        showToast('Vui lng m ci t Email trc khi lu!', 'warning');
        return;
      }

      const headerHtml = quillHeader.root.innerHTML;
      const footerHtml = quillFooter.root.innerHTML;

      console.log(' [EmailEditor] Saving...', { folderUrl, senderName });

      if (!folderUrl) {
        showToast('Vui lng nhp Link Folder Drive!', 'warning');
        return;
      }

      showToast('ang lu cu hnh...', 'info');
      try {
        const payload = {
          driveFolderId: folderUrl,
          emailHeader: headerHtml,
          emailFooter: footerHtml,
          defaultSenderName: senderName
        };

        const res = await callAPI('saveEmailSettings', { settings: payload });

        if (res.success) {
          showToast(res.message, 'success');
          closeEmailSettingsModal();
        } else {
          showToast(res.message, 'error');
        }
      } catch (e) {
        console.error(' [EmailEditor] Frontend Error:', e);
        showToast('Li lu cu hnh: ' + e.toString(), 'error');
      }
    }

  </script>
</body>

</html>


